import{_ as r,c as d,I as i,j as s,w as t,a,au as h,D as l,o}from"./chunks/framework.RMxno62p.js";const I=JSON.parse('{"title":"OpenResty è®°å½• JWT ä¸­çš„ userId","description":"","frontmatter":{"tags":["è®¡ç®—æœº/ç½‘ç»œ/ç½‘å…³/Nginx","è®¡ç®—æœº/ç½‘ç»œ/ç½‘å…³/OpenResty","å¼€å‘/è¯­è¨€/Lua","å¼€å‘/JWT","å¼€å‘/è¯­è¨€/Lua/luajit"]},"headers":[],"relativePath":"ç¬”è®°/ğŸ› ï¸ å¼€å‘/ğŸšª ç½‘å…³/OpenResty è®°å½• JWT ä¸­çš„ userId.md","filePath":"ç¬”è®°/ğŸ› ï¸ å¼€å‘/ğŸšª ç½‘å…³/OpenResty è®°å½• JWT ä¸­çš„ userId.md"}'),y={name:"ç¬”è®°/ğŸ› ï¸ å¼€å‘/ğŸšª ç½‘å…³/OpenResty è®°å½• JWT ä¸­çš„ userId.md"},g=s("h1",{id:"openresty-è®°å½•-jwt-ä¸­çš„-userid",tabindex:"-1"},[a("OpenResty è®°å½• JWT ä¸­çš„ userId "),s("a",{class:"header-anchor",href:"#openresty-è®°å½•-jwt-ä¸­çš„-userid","aria-label":'Permalink to "OpenResty è®°å½• JWT ä¸­çš„ userId"'},"â€‹")],-1),c=h('<h5 id="æ–‡æ¡£ç‰ˆæœ¬" tabindex="-1">æ–‡æ¡£ç‰ˆæœ¬ <a class="header-anchor" href="#æ–‡æ¡£ç‰ˆæœ¬" aria-label="Permalink to &quot;æ–‡æ¡£ç‰ˆæœ¬&quot;">â€‹</a></h5><table tabindex="0"><thead><tr><th>ç¼–è¾‘è€…</th><th>ç‰ˆæœ¬</th><th>å˜æ›´æ—¥æœŸ</th><th>å˜æ›´è¯´æ˜</th></tr></thead><tbody><tr><td>Neko</td><td>v1.0.0</td><td>2022-08-18</td><td>åˆ›å»º</td></tr></tbody></table><h3 id="æ–‡æ¡£å…¼å®¹æ€§" tabindex="-1">æ–‡æ¡£å…¼å®¹æ€§ <a class="header-anchor" href="#æ–‡æ¡£å…¼å®¹æ€§" aria-label="Permalink to &quot;æ–‡æ¡£å…¼å®¹æ€§&quot;">â€‹</a></h3>',3),u={tabindex:"0"},B=s("thead",null,[s("tr",null,[s("th",null,"ä¸»ä½“"),s("th",null,"ç‰ˆæœ¬å·"),s("th",null,"æ–‡æ¡£åœ°å€ï¼ˆå¦‚æœæœ‰ï¼‰")])],-1),C=s("tr",null,[s("td",null,"Debian"),s("td",null,"11/5.10.127-1/amd64"),s("td")],-1),F=s("td",null,"OpenResty",-1),E=s("td",null,"openresty/1.21.4.1",-1),A=s("td",null,"SkyLothar/lua-resty-jwt",-1),D=s("td",null,"0.1.11",-1),_=s("td",null,"cloudflare/lua-resty-cookie",-1),q=s("td",null,"0.0.0",-1),b=h('<h2 id="å®‰è£…-lua-resty-jwt" tabindex="-1">å®‰è£… lua-resty-jwt <a class="header-anchor" href="#å®‰è£…-lua-resty-jwt" aria-label="Permalink to &quot;å®‰è£… lua-resty-jwt&quot;">â€‹</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> opm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> SkyLothar/lua-resty-jwt</span></span></code></pre></div><h2 id="å®‰è£…-lua-resty-cookie" tabindex="-1">å®‰è£… lua-resty-cookie <a class="header-anchor" href="#å®‰è£…-lua-resty-cookie" aria-label="Permalink to &quot;å®‰è£… lua-resty-cookie&quot;">â€‹</a></h2>',3),m=h(`<div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https://github.com/cloudflare/lua-resty-cookie.git</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">scp</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> lib/resty/cookie.lua</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">ç›®æ ‡æœºå™¨</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Hos</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">t</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:~/</span></span></code></pre></div><p>è®¿é—®è¿œç¨‹æœåŠ¡å™¨å¹¶æ”¾ç½®åˆ° <code>/usr/local/openresty/lualib/resty/</code> ç›®å½•ä¸‹</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cp</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ~/cookie.lua</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /usr/local/openresty/lualib/resty/</span></span></code></pre></div><h2 id="åˆ›å»º-lua-è„šæœ¬ç›®å½•" tabindex="-1">åˆ›å»º lua è„šæœ¬ç›®å½• <a class="header-anchor" href="#åˆ›å»º-lua-è„šæœ¬ç›®å½•" aria-label="Permalink to &quot;åˆ›å»º lua è„šæœ¬ç›®å½•&quot;">â€‹</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /etc/openresty/lua</span></span></code></pre></div><h2 id="åˆ›å»ºè®°å½•-userid-çš„-lua-è„šæœ¬" tabindex="-1">åˆ›å»ºè®°å½• UserID çš„ lua è„šæœ¬ <a class="header-anchor" href="#åˆ›å»ºè®°å½•-userid-çš„-lua-è„šæœ¬" aria-label="Permalink to &quot;åˆ›å»ºè®°å½• UserID çš„ lua è„šæœ¬&quot;">â€‹</a></h2><p>ç¼–è¾‘ <code>/etc/openresty/lua/log_uid.lua</code> æ–‡ä»¶å¹¶å†™å…¥ä¸‹é¢çš„ä»£ç </p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> cjson</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;cjson&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> jwt</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;resty.jwt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> cookie</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;resty.cookie&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> secret</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;&lt;å¡«å†™ä½ çš„ JWT åŠ å¯†å¯†é’¥&gt;&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> jwt_cookie_name</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;&lt;JWT åœ¨ Cookie å¤´ä¸­çš„ Cookie åç§°&gt;&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> jwt_user_id_field_name</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;userId&quot; </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">-- è¿™é‡Œæˆ‘çš„ userId å­—æ®µç›´æ¥å­˜æ”¾åœ¨ payload ä¸‹é¢ï¼Œå¯ä»¥æŒ‰éœ€è¿›è¡Œå˜æ›´</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> ck</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> cookie</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#61AFEF;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> not</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> ck</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    return</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> fields</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> ck</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#61AFEF;">get_all</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> not</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> fields</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    ngx</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">ngx</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">ERR</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    return</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> k</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">v</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> pairs</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">fields</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">do</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> k</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> jwt_cookie_name</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        local</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> jwt_obj</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> jwt</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#61AFEF;">verify</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">secret</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">v</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> jwt_obj</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;verified&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> jwt_obj</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;valid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> jwt_obj</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;payload&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">and</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> jwt_obj</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;payload&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">][</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">jwt_user_id_field_name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">~=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> nil</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> then</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">                ngx</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">uid</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> jwt_obj</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;payload&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">][</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">jwt_user_id_field_name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">-- å°† userId å­—æ®µå–å‡ºæ¥æ”¾åˆ° $uid å˜é‡ä¸­</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">            end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">end</span></span></code></pre></div><h2 id="openresty-æ—¥å¿—å­—æ®µä¸­é…ç½®è¾“å‡º-uid-å˜é‡" tabindex="-1">OpenResty æ—¥å¿—å­—æ®µä¸­é…ç½®è¾“å‡º uid å˜é‡ <a class="header-anchor" href="#openresty-æ—¥å¿—å­—æ®µä¸­é…ç½®è¾“å‡º-uid-å˜é‡" aria-label="Permalink to &quot;OpenResty æ—¥å¿—å­—æ®µä¸­é…ç½®è¾“å‡º uid å˜é‡&quot;">â€‹</a></h2><p>ç¼–è¾‘ <code>/etc/openresty/nginx.conf</code></p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    log_format </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">json </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;{&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;@timestamp&quot;:&quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">time_iso8601</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;client_ip&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">remote_addr</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;request_uri&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">uri</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;host&quot;:&quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">host</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;method&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">request_method</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;request&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">request</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;status&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">status</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;body_bytes_sent&quot;: $</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">body_bytes_sent</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;referer&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">http_referer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;ua&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">http_user_agent</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;request_time&quot;: $</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">request_time</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;upstream_connect_time&quot;: $</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">upstream_connect_time</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;upstream_header_time&quot;: $</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">upstream_header_time</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;upstream_response_time&quot;: $</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">upstream_response_time</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;uid&quot;: $</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">uid</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # è¡¥å……é…ç½®è¯¥è¡Œæ–‡æœ¬</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    &#39;}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    access_log </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> /var/log/nginx/access.log json;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><h2 id="openresty-æœåŠ¡é…ç½®ä¸­åˆå§‹åŒ–-uid-å˜é‡å¹¶å¯¼å…¥éœ€è¦æ‰§è¡Œçš„-lua-è„šæœ¬" tabindex="-1">OpenResty æœåŠ¡é…ç½®ä¸­åˆå§‹åŒ– uid å˜é‡å¹¶å¯¼å…¥éœ€è¦æ‰§è¡Œçš„ lua è„šæœ¬ <a class="header-anchor" href="#openresty-æœåŠ¡é…ç½®ä¸­åˆå§‹åŒ–-uid-å˜é‡å¹¶å¯¼å…¥éœ€è¦æ‰§è¡Œçš„-lua-è„šæœ¬" aria-label="Permalink to &quot;OpenResty æœåŠ¡é…ç½®ä¸­åˆå§‹åŒ– uid å˜é‡å¹¶å¯¼å…¥éœ€è¦æ‰§è¡Œçš„ lua è„šæœ¬&quot;">â€‹</a></h2><p>ç¼–è¾‘æ¯ä¸€ä¸ªéœ€è¦è®°å½• uid çš„ vhost é…ç½®æ–‡ä»¶</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">80</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> default_server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server_name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">_;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        set </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">uid</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;0&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># æ­¤å¤„åˆå§‹åŒ–å˜é‡</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 301</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> https://$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">host</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">request_uri</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">443</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ssl http2 </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">default_server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        server_name </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">_;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        set </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">uid</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;0&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># æ­¤å¤„åˆå§‹åŒ–å˜é‡</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> / </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">            access_by_lua_file</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> /etc/openresty/lua/log_uid.lua; </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># æ­¤å¤„å¯¼å…¥éœ€è¦æ‰§è¡Œçš„è„šæœ¬</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">            ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">w</span></span></code></pre></div><h2 id="æ£€æŸ¥é…ç½®æ–‡ä»¶å¹¶é‡è½½" tabindex="-1">æ£€æŸ¥é…ç½®æ–‡ä»¶å¹¶é‡è½½ <a class="header-anchor" href="#æ£€æŸ¥é…ç½®æ–‡ä»¶å¹¶é‡è½½" aria-label="Permalink to &quot;æ£€æŸ¥é…ç½®æ–‡ä»¶å¹¶é‡è½½&quot;">â€‹</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> reload</span></span></code></pre></div>`,16);function f(v,x,j,T,w,P){const e=l("NolebasePageProperties"),n=l("VPNolebaseInlineLinkPreview"),k=l("NolebaseGitContributors"),p=l("NolebaseGitChangelog");return o(),d("div",null,[g,i(e),c,s("table",u,[B,s("tbody",null,[C,s("tr",null,[F,E,s("td",null,[i(n,{href:"https://openresty.org/en/",target:"_blank",rel:"noreferrer"},{default:t(()=>[a("OpenRestyÂ® - Official Site")]),_:1})])]),s("tr",null,[A,D,s("td",null,[i(n,{href:"https://github.com/SkyLothar/lua-resty-jwt",target:"_blank",rel:"noreferrer"},{default:t(()=>[a("SkyLothar/lua-resty-jwt: JWT For The Great Openresty")]),_:1})])]),s("tr",null,[_,q,s("td",null,[i(n,{href:"https://github.com/cloudflare/lua-resty-cookie",target:"_blank",rel:"noreferrer"},{default:t(()=>[a("cloudflare/lua-resty-cookie: Lua library for HTTP cookie manipulations for OpenResty/ngx_lua")]),_:1})])])])]),b,s("p",null,[a("å…‹éš† "),i(n,{href:"https://github.com/cloudflare/lua-resty-cookie",target:"_blank",rel:"noreferrer"},{default:t(()=>[a("cloudflare/lua-resty-cookie")]),_:1}),a(" åˆ°æœ¬åœ°ï¼Œä½¿ç”¨ scp æˆ–è€… rsync ä¼ è¾“åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸Š")]),m,i(k),i(p)])}const R=r(y,[["render",f]]);export{I as __pageData,R as default};
