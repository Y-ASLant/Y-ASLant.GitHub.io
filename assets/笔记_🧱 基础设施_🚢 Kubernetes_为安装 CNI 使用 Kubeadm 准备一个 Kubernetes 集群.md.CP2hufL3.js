import{_ as d,c as r,I as a,j as s,w as l,a as i,au as t,D as h,o}from"./chunks/framework.RMxno62p.js";const O=JSON.parse('{"title":"为安装 CNI 使用 Kubeadm 准备一个 Kubernetes 集群","description":"","frontmatter":{"tags":["运维/云原生/Kubernetes","运维/云原生/Kubernetes/K8s","开发/云原生/Kubernetes","开发/云原生/Kubernetes/K8s","计算机/操作系统/Linux","计算机/操作系统/Linux/命令行","操作系统/Linux","开发/云原生/容器网络接口/CNI","命令行/kubeadm","软件/云原生/kubeadm","命令行/kubectl","软件/云原生/kubelet","软件/云原生/kubectl","运维","开发/标记语言/YAML"]},"headers":[],"relativePath":"笔记/🧱 基础设施/🚢 Kubernetes/为安装 CNI 使用 Kubeadm 准备一个 Kubernetes 集群.md","filePath":"笔记/🧱 基础设施/🚢 Kubernetes/为安装 CNI 使用 Kubeadm 准备一个 Kubernetes 集群.md"}'),g={name:"笔记/🧱 基础设施/🚢 Kubernetes/为安装 CNI 使用 Kubeadm 准备一个 Kubernetes 集群.md"},c=s("h1",{id:"为安装-cni-使用-kubeadm-准备一个-kubernetes-集群",tabindex:"-1"},[i("为安装 CNI 使用 Kubeadm 准备一个 Kubernetes 集群 "),s("a",{class:"header-anchor",href:"#为安装-cni-使用-kubeadm-准备一个-kubernetes-集群","aria-label":'Permalink to "为安装 CNI 使用 Kubeadm 准备一个 Kubernetes 集群"'},"​")],-1),y=s("h3",{id:"文档兼容性",tabindex:"-1"},[i("文档兼容性 "),s("a",{class:"header-anchor",href:"#文档兼容性","aria-label":'Permalink to "文档兼容性"'},"​")],-1),C={tabindex:"0"},F=s("thead",null,[s("tr",null,[s("th",null,"主体"),s("th",null,"版本号"),s("th",null,"文档地址（如果有）")])],-1),u=s("tr",null,[s("td",null,"Debian"),s("td",null,"11"),s("td")],-1),B=s("td",null,"Kubernetes",-1),b=s("td",null,"1.28",-1),A=s("td",null,"Docker",-1),E=s("td",null,"24.0.2",-1),m=s("tr",null,[s("td",null,"containerd"),s("td",null,"1.7.6"),s("td")],-1),v=s("tr",null,[s("td",null,"Linux kernel"),s("td",null,"5.10.0"),s("td")],-1),f=s("h2",{id:"先决条件",tabindex:"-1"},[i("先决条件 "),s("a",{class:"header-anchor",href:"#先决条件","aria-label":'Permalink to "先决条件"'},"​")],-1),_=t(`<h2 id="准备配置文件" tabindex="-1">准备配置文件 <a class="header-anchor" href="#准备配置文件" aria-label="Permalink to &quot;准备配置文件&quot;">​</a></h2><p>我们用配置文件的形式来安装和部署 Kubernetes 集群，首先我们产出一下 部署用的配置文件：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> print</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> init-defaults</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --kubeconfig</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ClusterConfiguration</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm.yml</span></span></code></pre></div><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-RM7wa" id="tab-LZPOA7k" checked><label for="tab-LZPOA7k">高亮修改的部分</label><input type="radio" name="group-RM7wa" id="tab-2_qlx9h"><label for="tab-2_qlx9h">高亮与默认配置对比后的差异</label></div><div class="blocks"><div class="language-yaml vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light one-dark-pro has-highlighted vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kubeadm.k8s.io/v1beta3</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">InitConfiguration</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">bootstrapTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">groups</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">system:bootstrappers:kubeadm:default-node-token</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  token</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">abcdef.0123456789abcdef</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  ttl</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">24h0m0s</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  usages</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">signing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">authentication</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">localAPIEndpoint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 这里填写控制平面节点的 IP</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  advertiseAddress</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.24.0.2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  bindPort</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">6443</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">nodeRegistration</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 记得确认一下是否是使用的 containerd 和 UNIX Socket 是否配置到了这个路径上</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  criSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">unix:///var/run/containerd/containerd.sock</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  imagePullPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 这里填写我们的节点 1 的名字</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">node1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  taints</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">null</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kubeadm.k8s.io/v1beta3</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">ClusterConfiguration</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">apiServer</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  timeoutForControlPlane</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">20m0s</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # 这里我们可以稍微调大一些</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 这里可以添加一下你期望在生成 Kubernetes API Server</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 证书的时候额外支持的 SAN（Subject Alternative Names）</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  certSANs</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">   - </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">node01</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">   - </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.24.0.2</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">   - </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">k8s.ihome.cat</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">certificatesDir</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/etc/kubernetes/pki</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">clusterName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">homelab-kubernetes-1</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # 可以改成自己期望的集群名字</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">controllerManager</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: {}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">dns</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: {}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">etcd</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    dataDir</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/var/lib/etcd</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">imageRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">registry.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">kubernetesVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1.28.0</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">networking</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 选择一个喜欢的 Pod 使用的 CIDR，之后安装 Cilium 的时候也会用到</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  podSubnet</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">10.244.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  dnsDomain</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cluster.local</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  serviceSubnet</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">10.96.0.0/12</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">scheduler</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: {}</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light one-dark-pro has-diff vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kubeadm.k8s.io/v1beta3</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">InitConfiguration</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">bootstrapTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">groups</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">system:bootstrappers:kubeadm:default-node-token</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  token</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">abcdef.0123456789abcdef</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  ttl</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">24h0m0s</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  usages</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">signing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">authentication</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">localAPIEndpoint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 这里填写控制平面节点的 IP</span></span>
<span class="line diff remove"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  advertiseAddress</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1.2.3.4</span></span>
<span class="line diff add"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  advertiseAddress</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.24.0.2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  bindPort</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">6443</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">nodeRegistration</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 记得确认一下是否是使用的 containerd 和 UNIX Socket 是否配置到了这个路径上</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  criSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">unix:///var/run/containerd/containerd.sock</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  imagePullPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 这里填写我们的节点 1 的名字</span></span>
<span class="line diff remove"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">node</span></span>
<span class="line diff add"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">node1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  taints</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">null</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kubeadm.k8s.io/v1beta3</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">ClusterConfiguration</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">apiServer</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line diff remove"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  timeoutForControlPlane</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">4m0s</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # 这里我们可以稍微调大一些</span></span>
<span class="line diff add"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  timeoutForControlPlane</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">20m0s</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # 这里我们可以稍微调大一些</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 这里可以添加一下你期望在生成 Kubernetes API Server</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 证书的时候额外支持的 SAN（Subject Alternative Names）</span></span>
<span class="line diff add"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  certSANs</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span></span>
<span class="line diff add"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">   - </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">node01</span></span>
<span class="line diff add"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">   - </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.24.0.2</span></span>
<span class="line diff add"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">   - </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">k8s.ihome.cat</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">certificatesDir</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/etc/kubernetes/pki</span></span>
<span class="line diff remove"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">clusterName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kubernetes</span></span>
<span class="line diff add"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">clusterName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">homelab-kubernetes-1</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # 可以改成自己期望的集群名字</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">controllerManager</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: {}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">dns</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: {}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">etcd</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    dataDir</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/var/lib/etcd</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">imageRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">registry.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">kubernetesVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1.28.0</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">networking</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 选择一个喜欢的 Pod 使用的 CIDR，之后安装 Cilium 的时候也会用到</span></span>
<span class="line diff add"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  podSubnet</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">10.244.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  dnsDomain</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cluster.local</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  serviceSubnet</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">10.96.0.0/12</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">scheduler</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: {}</span></span></code></pre></div></div></div><h2 id="准备镜像" tabindex="-1">准备镜像 <a class="header-anchor" href="#准备镜像" aria-label="Permalink to &quot;准备镜像&quot;">​</a></h2><p>然后我们可以列出一下我们需要的镜像：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> images</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> list</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm.yml</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> images</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> list</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm.yml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">registry.k8s.io/kube-apiserver:v1.28.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">registry.k8s.io/kube-controller-manager:v1.28.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">registry.k8s.io/kube-scheduler:v1.28.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">registry.k8s.io/kube-proxy:v1.28.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">registry.k8s.io/pause:3.9</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">registry.k8s.io/etcd:3.5.9-0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">registry.k8s.io/coredns/coredns:v1.10.1</span></span></code></pre></div><p>提前预备好镜像：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> images</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pull</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm.yml</span></span></code></pre></div><h2 id="开始部署" tabindex="-1">开始部署 <a class="header-anchor" href="#开始部署" aria-label="Permalink to &quot;开始部署&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> init</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --config=kubeadm.yml</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --upload-certs</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --skip-phases=addon/kube-proxy</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --v=5</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm-init.log</span></span></code></pre></div>`,12),D=s("li",null,[s("code",null,"--upload-certs"),i("：方便后续同步和加入节点")],-1),x=s("code",null,"--skip-phases=addon/kube-proxy",-1),P=s("code",null,"--skip-phases",-1),N=s("li",null,[s("code",null,"--v=5"),i("：将输出等级调到 5，这样的话，如果我们中途遇到了什么报错，可以看到准确的调用栈")],-1),K=t(`<p>执行：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> init</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --config=kubeadm.yml</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --upload-certs</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --skip-phases=addon/kube-proxy</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --v=5</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm-init.log</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Your</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Kubernetes</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> has</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> initialized</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> successfully!</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">To</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> your</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cluster,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> you</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> need</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> following</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> as</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> regular</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> user:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> $HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/.kube</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cp</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /etc/kubernetes/admin.conf</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> $HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/.kube/config</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> chown</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">id</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">id</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -g</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Alternatively,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> if</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> you</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> are</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> user,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> you</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> can</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> run:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  export</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> KUBECONFIG</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">etc</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">kubernetes</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">admin</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">You</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> should</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> now</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> deploy</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pod</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> network</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cluster.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Run</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;kubectl apply -f [podnetwork].yaml&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> one</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> options</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> listed</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> at:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Then</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> you</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> can</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> join</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> any</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> number</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> worker</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nodes</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> by</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> running</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> following</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> each</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> as</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> join</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 10.24.0.2:6443</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --token</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">加入集群使用的</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> TOKE</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">N</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	--discovery-token-ca-cert-hash</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sha256:365eab797f1503ad6d24809ad253323aa9c6990069d8b3b367078bdf188e0296</span></span></code></pre></div><p>当我们看到 <code>Your Kubernetes control-plane has initialized successfully!</code> 字样之后就代表我们准备好了。</p><h2 id="分发凭据" tabindex="-1">分发凭据 <a class="header-anchor" href="#分发凭据" aria-label="Permalink to &quot;分发凭据&quot;">​</a></h2><p>现在我们可以把 <code>kubectl</code> 需要的凭据文件复制给用户了。</p><div class="warning custom-block github-alert"><p class="custom-block-title">⚠️ 注意</p><p>这样的操作仅适用于部署和维护 Kubernetes 集群的第一个用户，或者 root 用户，对于其他用户而言，请参照 Kubernetes 文档中对于多用户和授权的描述来分配权限。</p></div><h3 id="仅-root-用户使用或普通用户需要-sudoer-权限才能使用" tabindex="-1">仅 root 用户使用或普通用户需要 sudoer 权限才能使用 <a class="header-anchor" href="#仅-root-用户使用或普通用户需要-sudoer-权限才能使用" aria-label="Permalink to &quot;仅 root 用户使用或普通用户需要 sudoer 权限才能使用&quot;">​</a></h3><p>有两个选择：</p><ol><li>复制为 <code>/root/.kube/config</code></li><li>我们在 root 用户下配置 <code>.bash_profile</code> 或者 <code>.zshrc</code></li></ol><h4 id="复制为-root-kube-config" tabindex="-1">复制为 <code>/root/.kube/config</code> <a class="header-anchor" href="#复制为-root-kube-config" aria-label="Permalink to &quot;复制为 \`/root/.kube/config\`&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /root/.kube</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cp</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /etc/kubernetes/admin.conf</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /root/.kube/config</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> chown</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> root:root</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /root/.kube/config</span></span></code></pre></div><h4 id="复用配置文件路径" tabindex="-1">复用配置文件路径 <a class="header-anchor" href="#复用配置文件路径" aria-label="Permalink to &quot;复用配置文件路径&quot;">​</a></h4><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-vPCyM" id="tab-KYJLDDu" checked><label for="tab-KYJLDDu">bash</label><input type="radio" name="group-vPCyM" id="tab-cIxnZ7V"><label for="tab-cIxnZ7V">zsh</label></div><div class="blocks"><div class="language-shell vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .bashrc</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">source</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .bashrc</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .zshrc</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">source</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> .zshrc</span></span></code></pre></div></div></div><h3 id="仅授权用户使用" tabindex="-1">仅授权用户使用 <a class="header-anchor" href="#仅授权用户使用" aria-label="Permalink to &quot;仅授权用户使用&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> $USERNAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/.kube</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cp</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /etc/kubernetes/admin.conf</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> $USERNAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/.kube/config</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> chown</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> $USERNAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$USERGROUP</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> $USERNAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/.kube/config</span></span></code></pre></div><h3 id="仅我们自己使用" tabindex="-1">仅我们自己使用 <a class="header-anchor" href="#仅我们自己使用" aria-label="Permalink to &quot;仅我们自己使用&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> $HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/.kube</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cp</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /etc/kubernetes/admin.conf</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> $HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/.kube/config</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> chown</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">id</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">id</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -g</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">$HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/.kube/config</span></span></code></pre></div><h2 id="验证安装" tabindex="-1">验证安装 <a class="header-anchor" href="#验证安装" aria-label="Permalink to &quot;验证安装&quot;">​</a></h2><p>这个时候我们使用 <code>kubectl</code> 验证安装：</p><h3 id="查看-node-列表" tabindex="-1">查看 Node 列表 <a class="header-anchor" href="#查看-node-列表" aria-label="Permalink to &quot;查看 Node 列表&quot;">​</a></h3><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group----2A" id="tab-sPee2jR" checked><label for="tab-sPee2jR">仅 root 用户使用</label><input type="radio" name="group----2A" id="tab-Av9GKpL"><label for="tab-Av9GKpL">仅我们自己使用</label></div><div class="blocks"><div class="language-shell vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nodes</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nodes</span></span></code></pre></div></div></div><p>如果看到输出了 <code>NotReady</code>，是正常的，因为我们跳过了 <code>kube-proxy</code> 安装和暂时没有配置 CNI，如果你现在通过</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubelet</span></span></code></pre></div><p>观察 <code>kubelet</code> 的日志输出的话能够发现它会报错说 <code>cni plugin not initialized</code>。我们之后安装像是 Cilium 或者 Calico 这样的 CNI 插件之后就会恢复正常了。</p><h3 id="查看-pod-列表" tabindex="-1">查看 Pod 列表 <a class="header-anchor" href="#查看-pod-列表" aria-label="Permalink to &quot;查看 Pod 列表&quot;">​</a></h3><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-9K5bb" id="tab-V5swBgu" checked><label for="tab-V5swBgu">仅 root 用户使用</label><input type="radio" name="group-9K5bb" id="tab-kUDjdk9"><label for="tab-kUDjdk9">仅我们自己使用</label></div><div class="blocks"><div class="language-shell vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pods</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kube-system</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nodes</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kube-system</span></span></code></pre></div></div></div><h2 id="添加其他节点" tabindex="-1">添加其他节点 <a class="header-anchor" href="#添加其他节点" aria-label="Permalink to &quot;添加其他节点&quot;">​</a></h2><p>接下来可以在别的节点机器上执行它在上面的结果中输出的</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> join</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 10.24.0.2:6443</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --token</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">加入集群使用的</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> TOKE</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">N</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	--discovery-token-ca-cert-hash</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sha256:365eab797f1503ad6d24809ad253323aa9c6990069d8b3b367078bdf188e0296</span></span></code></pre></div><p>命令来加入到集群。</p>`,30),I=t('<div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> token</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> create</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --print-join-command</span></span></code></pre></div><p>来创建和打印加入集群需要的 Token 和命令。</p>',2);function q(S,T,w,V,R,$){const e=h("NolebasePageProperties"),n=h("VPNolebaseInlineLinkPreview"),k=h("NolebaseGitContributors"),p=h("NolebaseGitChangelog");return o(),r("div",null,[c,a(e),y,s("table",C,[F,s("tbody",null,[u,s("tr",null,[B,b,s("td",null,[a(n,{href:"https://v1-28.docs.kubernetes.io/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("https://v1-28.docs.kubernetes.io/")]),_:1})])]),s("tr",null,[A,E,s("td",null,[a(n,{href:"https://docs.docker.com/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("https://docs.docker.com/")]),_:1})])]),m,v])]),f,s("ul",null,[s("li",null,[a(n,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/重置 Kubernetes 集群.html"},{default:l(()=>[i("重置 Kubernetes 集群")]),_:1})]),s("li",null,[a(n,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/准备 Kubernetes 节点裸金属虚拟机.html"},{default:l(()=>[i("准备 Kubernetes 节点裸金属虚拟机")]),_:1})])]),_,s("ul",null,[D,s("li",null,[x,i("：根据 Cilium 的文档 "),a(n,{href:"https://docs.cilium.io/en/stable/installation/k8s-install-kubeadm/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Installation using kubeadm — Cilium 1.14.2 documentation")]),_:1}),i(" 要求的添加参数 "),P,i("，如果你安装的是 Calico 或者其他的 CNI，请多阅读和参考他们的文档")]),N]),K,s("p",null,[i("当然如果你错过了这条消息，也可以通过"),a(n,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/创建加入集群的 Token 并输出命令.html"},{default:l(()=>[i("创建加入集群的 Token 并输出命令")]),_:1}),i("中提到的：")]),I,a(k),a(p)])}const L=d(g,[["render",q]]);export{O as __pageData,L as default};
