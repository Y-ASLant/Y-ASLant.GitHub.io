import{_ as e,c as p,I as s,j as a,a as h,au as k,D as i,o as d}from"./chunks/framework.RMxno62p.js";const D=JSON.parse('{"title":"ä¸º Nginx é…ç½® TCP åå‘ä»£ç†","description":"","frontmatter":{"tags":["è®¡ç®—æœº/ç½‘ç»œ/ç½‘å…³/Nginx","è®¡ç®—æœº/ç½‘ç»œ/ç½‘å…³","è®¡ç®—æœº/ç½‘ç»œ/ç½‘å…³/OpenResty","å‘½ä»¤è¡Œ/systemd","è®¡ç®—æœº/æ“ä½œç³»ç»Ÿ/Linux","è®¡ç®—æœº/æ“ä½œç³»ç»Ÿ/Linux/å‘½ä»¤è¡Œ","æ“ä½œç³»ç»Ÿ/Linux","æ“ä½œç³»ç»Ÿ/Debian","æ•°å­¦/å¯†ç å­¦/è¯ä¹¦/TLS","æ•°å­¦/å¯†ç å­¦/è¯ä¹¦/TLS/mTLS","å‘½ä»¤è¡Œ/kubectl","è½¯ä»¶/äº‘åŸç”Ÿ/kubectl","è®¡ç®—æœº/ç½‘ç»œ/åè®®/TCP"]},"headers":[],"relativePath":"ç¬”è®°/ğŸ› ï¸ å¼€å‘/ğŸ•¸ ç½‘ç»œ/ä¸º Nginx é…ç½® TCP åå‘ä»£ç†.md","filePath":"ç¬”è®°/ğŸ› ï¸ å¼€å‘/ğŸ•¸ ç½‘ç»œ/ä¸º Nginx é…ç½® TCP åå‘ä»£ç†.md"}'),o={name:"ç¬”è®°/ğŸ› ï¸ å¼€å‘/ğŸ•¸ ç½‘ç»œ/ä¸º Nginx é…ç½® TCP åå‘ä»£ç†.md"},r=a("h1",{id:"ä¸º-nginx-é…ç½®-tcp-åå‘ä»£ç†",tabindex:"-1"},[h("ä¸º Nginx é…ç½® TCP åå‘ä»£ç† "),a("a",{class:"header-anchor",href:"#ä¸º-nginx-é…ç½®-tcp-åå‘ä»£ç†","aria-label":'Permalink to "ä¸º Nginx é…ç½® TCP åå‘ä»£ç†"'},"â€‹")],-1),g=k(`<h2 id="åœ¨-nginx-ä¸»é…ç½®ä¸­æ·»åŠ å¯å¤ç”¨é…ç½®" tabindex="-1">åœ¨ Nginx ä¸»é…ç½®ä¸­æ·»åŠ å¯å¤ç”¨é…ç½® <a class="header-anchor" href="#åœ¨-nginx-ä¸»é…ç½®ä¸­æ·»åŠ å¯å¤ç”¨é…ç½®" aria-label="Permalink to &quot;åœ¨ Nginx ä¸»é…ç½®ä¸­æ·»åŠ å¯å¤ç”¨é…ç½®&quot;">â€‹</a></h2><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-qj_1r" id="tab-EUmKVaV" checked><label for="tab-EUmKVaV">è¾“å‡ºæ—¥å¿—ä¸º JSON</label><input type="radio" name="group-qj_1r" id="tab-WAshA7t"><label for="tab-WAshA7t">è¾“å‡ºæ—¥å¿—ä¸ºæ™®é€šçº¯æ–‡æœ¬</label></div><div class="blocks"><div class="language-nginx vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	log_format </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">tcp_json </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;{&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">		&#39;&quot;@timestamp&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">time_iso8601</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;remote_addr&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">remote_addr</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">		&#39;&quot;protocol&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">protocol</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">		&#39;&quot;status&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">status</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">		&#39;&quot;bytes_sent&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">bytes_sent</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">		&#39;&quot;bytes_received&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">bytes_received</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">		&#39;&quot;session_time&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">session_time</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">		&#39;&quot;upstream_addr&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">upstream_addr</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        &#39;&quot;upstream_bytes_sent&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">upstream_bytes_sent</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">		&#39;&quot;upstream_bytes_received&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">upstream_bytes_received</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;,&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">		&#39;&quot;upstream_connect_time&quot;: &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">upstream_connect_time</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">	&#39;}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	access_log </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">/var/log/nginx/tcp-access.log tcp_json buffer=512k flush=1m;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	include </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">/etc/nginx/tcp.d/*.conf;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stream</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	log_format </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">tcp_plain </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">remote_addr</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> [$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">time_local</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">] &#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">	        &#39;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">protocol</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">status</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">bytes_sent</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">bytes_received</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            &#39;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">session_time</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">upstream_addr</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot; &#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            &#39;&quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">upstream_bytes_sent</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot; &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">upstream_bytes_received</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot; &quot;$</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">upstream_connect_time</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	access_log </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">/var/log/nginx/tcp-access.log tcp_plain buffer=512k flush=1m;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	include </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">/etc/nginx/tcp.d/*.conf;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div></div></div><p>è¯´æ˜ï¼š</p><ul><li><code>log_format</code>ï¼šè¿™é‡Œæˆ‘ä½¿ç”¨çš„ JSON ä¸ºæ ¼å¼çš„æ—¥å¿—è¾“å‡ºï¼Œæ–¹ä¾¿é‡‡é›†å’Œå¤„ç†ï¼Œå¦‚æœä½ ä¸éœ€è¦ JSON æ ¼å¼ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸Šæ–¹åˆ‡æ¢æ¢æˆé JSON æ ¼å¼çš„é…ç½®æ–‡ä»¶ç„¶åå‚è€ƒé…ç½®ã€‚</li><li><code>access_log</code>ï¼šè¾“å‡ºåˆ° <code>/var/log/nginx/tcp-access.log</code>ï¼Œä¸ HTTP è¯·æ±‚çš„æ—¥å¿—ä¸åŒï¼ŒHTTP çš„æ”¾åœ¨ <code>/var/log/nginx/access.log</code> é‡Œé¢ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥æ··åˆå­˜æ”¾ã€‚</li><li><code>include</code>ï¼šä¸æ™®é€šçš„ HTTP è™šæ‹Ÿä¸»æœºé…ç½®é€šå¸¸å­˜æ”¾åœ¨ <code>/etc/nginx/conf.d</code> æˆ–è€…åœ¨ Debian ç³»åˆ—çš„å‘è¡Œç‰ˆä¸­çš„ <code>/etc/nginx/sites-enabled</code> å’Œ <code>/etc/nginx/sites-available</code> ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿåˆ›å»ºä¸€ä¸ª <code>/etc/nginx/tcp.d</code> æ¥å­˜æ”¾æˆ‘ä»¬çš„ TCP ä»£ç†ã€‚</li></ul><p>ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦é…ç½®æ­£ç¡®ï¼š</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -t</span></span></code></pre></div><p>é…ç½®ä¿å­˜åæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ›´æ–°é…ç½®ï¼š</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-ysMYe" id="tab-iHi5Gdw" checked><label for="tab-iHi5Gdw">é‡è½½é…ç½®</label><input type="radio" name="group-ysMYe" id="tab-UGN7pne"><label for="tab-UGN7pne">é‡å¯ Nginx Systemd å•å…ƒ</label></div><div class="blocks"><div class="language-shell vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> reload</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nginx</span></span></code></pre></div></div></div><p>ç„¶åè¿™ä¸ªæ—¶å€™å¯ä»¥æ·»åŠ æˆ‘ä»¬çš„ TCP åå‘ä»£ç†ç›®æ ‡äº†ã€‚</p><h2 id="æ·»åŠ -tcp-åå‘ä»£ç†é…ç½®æ¨¡å—" tabindex="-1">æ·»åŠ  TCP åå‘ä»£ç†é…ç½®æ¨¡å— <a class="header-anchor" href="#æ·»åŠ -tcp-åå‘ä»£ç†é…ç½®æ¨¡å—" aria-label="Permalink to &quot;æ·»åŠ  TCP åå‘ä»£ç†é…ç½®æ¨¡å—&quot;">â€‹</a></h2><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-KY7eK" id="tab-CrNIxJK" checked><label for="tab-CrNIxJK">é…ç½®åä»£ç†å…¶ä»–å„ç§æœåŠ¡</label><input type="radio" name="group-KY7eK" id="tab-Psx7ecB"><label for="tab-Psx7ecB">é…ç½® TLS åä»£ç†å…¶ä»–å„ç§æœåŠ¡</label><input type="radio" name="group-KY7eK" id="tab-EXyfXfg"><label for="tab-EXyfXfg">é…ç½® mTLS åä»£ç†å…¶ä»–å„ç§æœåŠ¡</label></div><div class="blocks"><div class="language-nginx vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> &lt;ä¸Šæ¸¸åç§°&gt; </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;IP&gt;:&lt;ç«¯å£&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    listen </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;ç½‘å…³å±‚å¸Œæœ›æš´éœ²çš„ç«¯å£&gt;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    proxy_connect_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">30s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;ä¸Šæ¸¸åç§°&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> &lt;ä¸Šæ¸¸åç§°&gt; </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;IP&gt;:&lt;ç«¯å£&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    listen </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;ç½‘å…³å±‚å¸Œæœ›æš´éœ²çš„ç«¯å£&gt; ssl;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	ssl_certificate </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">     &lt;è¯ä¹¦è·¯å¾„&gt;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    ssl_certificate_key </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;è¯ä¹¦ç§é’¥è·¯å¾„&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    proxy_connect_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">30s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;ä¸Šæ¸¸åç§°&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> &lt;ä¸Šæ¸¸åç§°&gt; </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;IP&gt;:&lt;ç«¯å£&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    listen </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;ç½‘å…³å±‚å¸Œæœ›æš´éœ²çš„ç«¯å£&gt; ssl;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	ssl_certificate </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">     &lt;è¯ä¹¦è·¯å¾„&gt;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    ssl_certificate_key </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;è¯ä¹¦ç§é’¥è·¯å¾„&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	ssl_client_certificate </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;ç”¨äºéªŒè¯å®¢æˆ·ç«¯è¯ä¹¦çš„è¯ä¹¦ CA é“¾æˆ–è€…å• CA è¯ä¹¦è·¯å¾„&gt;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    ssl_verify_client </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    ssl_verify_depth </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    proxy_connect_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">30s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;ä¸Šæ¸¸åç§°&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div></div></div><p>ä»¥æš´éœ² Kubernetes é›†ç¾¤ä¸ºä¾‹ï¼š</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> kubernetes_api_server_tcp </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰èŠ‚ç‚¹ IP&gt;:6443;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">	# å¦‚æœéƒ¨ç½²äº†å¤šä¸ªæ§åˆ¶å¹³é¢çš„è¯</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰èŠ‚ç‚¹ IP 2&gt;:6443;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> &lt;æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰èŠ‚ç‚¹ IP 3&gt;:6443;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">6443</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    proxy_connect_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">30s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">kubernetes_api_server_tcp;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><h2 id="è§‚å¯Ÿæ—¥å¿—è¾“å‡º" tabindex="-1">è§‚å¯Ÿæ—¥å¿—è¾“å‡º <a class="header-anchor" href="#è§‚å¯Ÿæ—¥å¿—è¾“å‡º" aria-label="Permalink to &quot;è§‚å¯Ÿæ—¥å¿—è¾“å‡º&quot;">â€‹</a></h2><p>æ¯”å¦‚å¯¹ Kubernetes çš„ API Server é…ç½®äº† TCP åå‘ä»£ç†è¿›è¡Œæš´éœ²ä¹‹åå¯ä»¥è¿è¡Œ <code>kubectl</code> æ¥è·å–é›†ç¾¤èµ„æºçœ‹çœ‹æ•ˆæœï¼š</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nodes</span></span></code></pre></div><p>è¿™ä¸ªæ—¶å€™å°±å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤åŒæ­¥è¾“å‡º Nginx çš„ TCP åå‘ä»£ç†æ—¥å¿—ï¼š</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /var/log/nginx/tcp-access.log</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /var/log/nginx/tcp-access.log</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">&quot;@timestamp&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;2023-10-14T16:09:35+08:00&quot;,&quot;remote_addr&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;10.0.2.145&quot;,&quot;protocol&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;TCP&quot;,&quot;status&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;200&quot;,&quot;bytes_sent&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;44205&quot;,&quot;bytes_received&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;3690&quot;,&quot;session_time&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;0.351&quot;,&quot;upstream_addr&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;10.24.0.2:6443&quot;,&quot;upstream_bytes_sent&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;3690&quot;,&quot;upstream_bytes_received&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;44205&quot;,&quot;upstream_connect_time&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;0.000&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">&quot;@timestamp&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;2023-10-14T16:09:37+08:00&quot;,&quot;remote_addr&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;10.0.2.145&quot;,&quot;protocol&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;TCP&quot;,&quot;status&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;200&quot;,&quot;bytes_sent&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;13264&quot;,&quot;bytes_received&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;1909&quot;,&quot;session_time&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;0.029&quot;,&quot;upstream_addr&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;10.24.0.2:6443&quot;,&quot;upstream_bytes_sent&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;1909&quot;,&quot;upstream_bytes_received&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;13264&quot;,&quot;upstream_connect_time&quot;:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;0.000&quot;}</span></span></code></pre></div>`,19);function c(y,u,C,B,F,q){const t=i("NolebasePageProperties"),n=i("NolebaseGitContributors"),l=i("NolebaseGitChangelog");return d(),p("div",null,[r,s(t),g,s(n),s(l)])}const b=e(o,[["render",c]]);export{D as __pageData,b as default};
