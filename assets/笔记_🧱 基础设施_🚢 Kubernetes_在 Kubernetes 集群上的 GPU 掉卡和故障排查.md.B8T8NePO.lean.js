import{_ as r,c as d,I as a,j as i,a as s,w as h,au as t,D as l,o as g}from"./chunks/framework.RMxno62p.js";const _s=JSON.parse('{"title":"在 Kubernetes 集群上的 GPU 掉卡和故障排查","description":"","frontmatter":{"tags":["AI/硬件/GPU","AI/硬件/GPU/NVIDIA","AI/硬件/GPU/NVIDIA/GPU","运维/云原生/Kubernetes","开发/云原生/Kubernetes","命令行/kubectl","命令行/lshw","命令行/lspci","命令行/dmesg","命令行/dcgmi","命令行/nvidia-smi","AI","基础设施/GPU","基础设施/GPU/DCGM","软件/开源/DCGM","开发/云原生/Kubernetes/GPU-Operator"]},"headers":[],"relativePath":"笔记/🧱 基础设施/🚢 Kubernetes/在 Kubernetes 集群上的 GPU 掉卡和故障排查.md","filePath":"笔记/🧱 基础设施/🚢 Kubernetes/在 Kubernetes 集群上的 GPU 掉卡和故障排查.md"}'),o={name:"笔记/🧱 基础设施/🚢 Kubernetes/在 Kubernetes 集群上的 GPU 掉卡和故障排查.md"},F=i("h1",{id:"在-kubernetes-集群上的-gpu-掉卡和故障排查",tabindex:"-1"},[s("在 Kubernetes 集群上的 GPU 掉卡和故障排查 "),i("a",{class:"header-anchor",href:"#在-kubernetes-集群上的-gpu-掉卡和故障排查","aria-label":'Permalink to "在 Kubernetes 集群上的 GPU 掉卡和故障排查"'},"​")],-1),y=t("",24),C=i("strong",null,[s("在 GPU Operator 安装了的 Kubernetes 集群的场景下，建议运维工程师和 Kubernetes 开发者在任意的安装有 NVIDIA 驱动的节点上运行 "),i("code",null,"/run/nvidia/driver/usr/bin/nvidia-bug-report.sh"),s(" 来实现和执行 "),i("code",null,"nvidia-bug-report.sh"),s(" 脚本来收集系统报告。")],-1),c=i("code",null,"nvidia-bug-report.sh",-1),A=t("",1),B={class:"info custom-block"},u=i("p",{class:"custom-block-title"},"INFO",-1),D=t("",7),b={class:"tip custom-block"},m=t("",5),f=i("code",null,"kubectl",-1),_=i("code",null,"docker",-1),v=t("",4),E={class:"tip custom-block"},I=t("",5),P=i("code",null,"kubectl",-1),x=i("code",null,"docker",-1),T=i("h3",{id:"通过-dcgmi-discovery-检查是否能探测到-gpu-设备",tabindex:"-1"},[s("通过 "),i("code",null,"dcgmi discovery"),s(" 检查是否能探测到 GPU 设备 "),i("a",{class:"header-anchor",href:"#通过-dcgmi-discovery-检查是否能探测到-gpu-设备","aria-label":'Permalink to "通过 `dcgmi discovery` 检查是否能探测到 GPU 设备"'},"​")],-1),G=i("p",null,[s("对于已经安装了 GPU Operator 的集群，可以通过 GPU Operator 下属的 "),i("code",null,"dcgm-exporter"),s(" Pod 资源内置的 "),i("code",null,"dcgmi"),s("（对 DCGM API 的本地封装的 CLI 版本）的命令对 GPU 进行故障排查。")],-1),V={class:"tip custom-block"},N=t("",5),U=i("code",null,"kubectl",-1),M=i("code",null,"docker",-1),w=i("code",null,"dcgmi discovery",-1),S=i("code",null,"nv-hostengine",-1),R=i("code",null,"nv-hostengine",-1),q=t("",3),L={class:"info custom-block"},K=t("",2),O=i("h3",{id:"通过-dcgmi-health-查看-gpu-设备健康状况",tabindex:"-1"},[s("通过 "),i("code",null,"dcgmi health"),s(" 查看 GPU 设备健康状况 "),i("a",{class:"header-anchor",href:"#通过-dcgmi-health-查看-gpu-设备健康状况","aria-label":'Permalink to "通过 `dcgmi health` 查看 GPU 设备健康状况"'},"​")],-1),Y=i("p",null,[s("对于已经安装了 GPU Operator 的集群，可以通过 GPU Operator 下属的 "),i("code",null,"dcgm-exporter"),s(" Pod 资源内置的 "),i("code",null,"dcgmi"),s("（对 DCGM API 的本地封装的 CLI 版本）的命令对 GPU 进行故障排查。")],-1),z={class:"tip custom-block"},J=t("",5),W=i("code",null,"kubectl",-1),X=i("code",null,"docker",-1),H=t("",4),j={class:"tip custom-block"},$=t("",5),Q=i("code",null,"kubectl",-1),Z=i("code",null,"docker",-1),ss=t("",3),is={class:"info custom-block"},as=i("p",{class:"custom-block-title"},[i("code",null,"dcgmi diag"),s(" 的 "),i("code",null,"-r"),s(" 参数有什么用")],-1),ns=t("",2),hs=i("code",null,"-r",-1),ts=t("",1),ls=t("",5),ks={class:"tip custom-block"},es=t("",5),ps=i("code",null,"kubectl",-1),rs=i("code",null,"docker",-1),ds=t("",2),gs={class:"info custom-block"},os=t("",3),Fs=t("",5),ys=i("h2",{id:"参考资料",tabindex:"-1"},[s("参考资料 "),i("a",{class:"header-anchor",href:"#参考资料","aria-label":'Permalink to "参考资料"'},"​")],-1),Cs=i("code",null,"dcgmi",-1);function cs(As,Bs,us,Ds,bs,ms){const k=l("NolebasePageProperties"),n=l("VPNolebaseInlineLinkPreview"),e=l("NolebaseGitContributors"),p=l("NolebaseGitChangelog");return g(),d("div",null,[F,a(k),i("p",null,[s("NVIDIA 有个 GPU 排查指南："),a(n,{href:"https://docs.nvidia.com/deploy/gpu-debug-guidelines/index.html",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("NVIDIA GPU Debug Guidelines - GPU Deployment and Management Documentation")]),_:1})]),y,i("p",null,[s("在 NVIDIA 支持社区有一个建议先阅读的发帖 "),a(n,{href:"https://forums.developer.nvidia.com/t/if-you-have-a-problem-please-read-this-first/27131",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("If you have a problem, PLEASE read this first")]),_:1}),s(" 中，以及在 NVIDIA 工程师于 "),a(n,{href:"https://github.com/NVIDIA/gpu-operator/issues/222",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("DCGM initialization error · Issue #222 · NVIDIA/gpu-operator")]),_:1}),s(" 中都建议到的，"),C]),i("p",null,[s("因此，可以通过执行下面的命令来执行通常情况下在 NVIDIA 官方文档 "),a(n,{href:"https://docs.nvidia.com/deploy/gpu-debug-guidelines/index.html",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("NVIDIA GPU Debug Guidelines")]),_:1}),s(" 和社区的建议中提及的 "),c]),A,i("div",B,[u,i("p",null,[s("如果你实在找不到，可以在 "),a(n,{href:"https://github.com/Pardus-Linux/Packages/blob/594b76c80a1ec2c82359602c6318bc1fde867b76/hardware/graphics/nvidia-xconfig/files/nvidia-bug-report.sh",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("Packages/hardware/graphics/nvidia-xconfig/files/nvidia-bug-report.sh")]),_:1}),s(" 下载和查阅到这个脚本的具体内容和执行的逻辑信息。")])]),D,i("div",b,[m,i("p",null,[s("如果你不熟悉 "),f,s(" 和 "),_,s(" CLI 的用法，可以通过这篇 "),a(n,{href:"https://kubernetes.io/docs/tasks/debug/debug-application/get-shell-running-container/",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("Get a Shell to a Running Container | Kubernetes")]),_:1}),s("文档学习和了解相关的用法。")])]),v,i("div",E,[I,i("p",null,[s("如果你不熟悉 "),P,s(" 和 "),x,s(" CLI 的用法，可以通过这篇 "),a(n,{href:"https://kubernetes.io/docs/tasks/debug/debug-application/get-shell-running-container/",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("Get a Shell to a Running Container | Kubernetes")]),_:1}),s("文档学习和了解相关的用法。")])]),T,G,i("div",V,[N,i("p",null,[s("如果你不熟悉 "),U,s(" 和 "),M,s(" CLI 的用法，可以通过这篇 "),a(n,{href:"https://kubernetes.io/docs/tasks/debug/debug-application/get-shell-running-container/",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("Get a Shell to a Running Container | Kubernetes")]),_:1}),s("文档学习和了解相关的用法。")])]),i("p",null,[s("想要运行 "),w,s("，你必须确保自己开启了 "),S,s(" 或者为 DCGM 配置了 embedding engine（参考 "),a(n,{href:"https://github.com/triton-inference-server/model_analyzer/issues/16",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("Error starting embedded DCGM engine · Issue #16 · triton-inference-server/model_analyzer")]),_:1}),s(" 给出的说明），想要了解 "),R,s("，请参考这篇文档："),a(n,{href:"/笔记/🧱 基础设施/nv-hostengine 的启动和补充知识.html"},{default:h(()=>[s("nv-hostengine 的启动和补充知识")]),_:1})]),q,i("div",L,[K,i("p",null,[s("请参考 "),a(n,{href:"/笔记/🧱 基础设施/nv-hostengine 的启动和补充知识.html"},{default:h(()=>[s("nv-hostengine 的启动和补充知识")]),_:1}),s(" 的指南启动或者配置 DCGM 的 embedding engine 激活 nv-hostengine 之后再次尝试。")])]),O,Y,i("div",z,[J,i("p",null,[s("如果你不熟悉 "),W,s(" 和 "),X,s(" CLI 的用法，可以通过这篇 "),a(n,{href:"https://kubernetes.io/docs/tasks/debug/debug-application/get-shell-running-container/",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("Get a Shell to a Running Container | Kubernetes")]),_:1}),s("文档学习和了解相关的用法。")])]),H,i("div",j,[$,i("p",null,[s("如果你不熟悉 "),Q,s(" 和 "),Z,s(" CLI 的用法，可以通过这篇 "),a(n,{href:"https://kubernetes.io/docs/tasks/debug/debug-application/get-shell-running-container/",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("Get a Shell to a Running Container | Kubernetes")]),_:1}),s("文档学习和了解相关的用法。")])]),ss,i("div",is,[as,i("p",null,[s("根据 "),a(n,{href:"https://microsoft.github.io/VirtualClient/docs/workloads/dcgmi/dcgmi-profiles/",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("DCGMI Workload Profiles | Virtual Client Platform")]),_:1}),s(" 文档叙述：")]),ns,i("p",null,[s("不同的 "),hs,s(" 参数的数值代表了不同的 Level，Level 就是所谓的「等级」，这样的等级会在背后运行不同的设备测试以方便工程师定位问题，对于不同的 Level 所附加的不同测试，可以参见 "),a(n,{href:"https://docs.nvidia.com/datacenter/dcgm/latest/user-guide/dcgm-diagnostics.html#run-levels-and-tests",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("DCGM Diagnostics — NVIDIA DCGM Documentation latest documentation")]),_:1}),s(" 文档中给出的下表：")]),ts]),ls,i("div",ks,[es,i("p",null,[s("如果你不熟悉 "),ps,s(" 和 "),rs,s(" CLI 的用法，可以通过这篇 "),a(n,{href:"https://kubernetes.io/docs/tasks/debug/debug-application/get-shell-running-container/",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("Get a Shell to a Running Container | Kubernetes")]),_:1}),s("文档学习和了解相关的用法。")])]),ds,i("div",gs,[os,i("p",null,[s("这个时候可以根据 "),a(n,{href:"https://github.com/NVIDIA/nvidia-docker/issues/1256",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("system has unsupported display driver / cuda driver combination · Issue #1256 · NVIDIA/nvidia-docker")]),_:1}),s(" 给出的指南，在 Kubernetes 正在运行的节点上检查安装的 NVIDIA 驱动包和 container 必要组件对应的版本号来确认是否正确配置 CUDA 和相关的库：")]),Fs]),ys,i("ul",null,[i("li",null,[a(n,{href:"https://www.cnblogs.com/jisongxie/p/10405302.html",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("nvidia-smi GPU异常消失 程序中断 - Jisongxie - 博客园")]),_:1})]),i("li",null,[a(n,{href:"https://catalog.ngc.nvidia.com/orgs/nvidia/containers/pytorch",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("PyTorch | NVIDIA NGC")]),_:1})]),i("li",null,[a(n,{href:"https://docs.nvidia.com/datacenter/tesla/hgx-software-guide/index.html",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("NVIDIA HGX A100 Software User Guide - NVIDIA Tesla Documentation")]),_:1})]),i("li",null,[a(n,{href:"https://microsoft.github.io/VirtualClient/docs/workloads/dcgmi/dcgmi-profiles/",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("DCGMI Workload Profiles | Virtual Client Platform")]),_:1})]),i("li",null,[a(n,{href:"https://zhuanlan.zhihu.com/p/361545761",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("PyTorch的CUDA错误：Error 804: forward compatibility was attempted on non supported HW - 知乎")]),_:1})]),i("li",null,[a(n,{href:"https://docs.nvidia.com/datacenter/dcgm/latest/user-guide/getting-started.html#embedded-mode",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("DCGM 的 嵌入模式 Getting Started — NVIDIA DCGM Documentation latest documentation")]),_:1})]),i("li",null,[a(n,{href:"https://docs.nvidia.com/deploy/nvml-api/nvml-api-reference.html#nvml-api-reference",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("NVML API Reference Guide - GPU Deployment and Management Documentation")]),_:1})]),i("li",null,[a(n,{href:"https://github.com/NVIDIA/gpu-operator/issues/294",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("DCGM exporter connection to server pod times out · Issue #294 · NVIDIA/gpu-operator")]),_:1})]),i("li",null,[a(n,{href:"https://www.cnblogs.com/maxgongzuo/p/12582286.html",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("AI模型运维——GPU性能监控NVML和DCGM - 沄持的学习记录 - 博客园")]),_:1})]),i("li",null,[a(n,{href:"https://developer.nvidia.com/blog/gpu-telemetry-nvidia-dcgm/",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("Setting Up GPU Telemetry with NVIDIA Data Center GPU Manager | NVIDIA Technical Blog")]),_:1})]),i("li",null,[a(n,{href:"https://cloud-atlas.readthedocs.io/zh-cn/latest/kubernetes/gpu/intergrate_gpu_telemetry_into_k8s.html",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("在Kuternetes集成GPU可观测能力 — Cloud Atlas beta 文档")]),_:1})]),i("li",null,[a(n,{href:"https://cloud-atlas.readthedocs.io/zh-cn/latest/kubernetes/gpu/intergrate_gpu_telemetry_into_k8s.html#dcgm",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("DCGM - 在Kuternetes集成GPU可观测能力 — Cloud Atlas beta 文档 (cloud-atlas.readthedocs.io)")]),_:1})]),i("li",null,[a(n,{href:"https://houmin.cc/posts/b4058e1b/",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("【系统监控】GPU 监控 | Houmin")]),_:1})]),i("li",null,[a(n,{href:"https://blog.searce.com/nvidia-a100-migs-gpu-monitoring-using-datadog-7c3d2378184f",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("Nvidia A100 MIGs GPU Monitoring using Datadog | by Aditya Bibave | Searce")]),_:1})]),i("li",null,[a(n,{href:"https://www.jianshu.com/p/f38e58864496",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("dcgm-exporter源码分析 - 简书")]),_:1})]),i("li",null,[a(n,{href:"https://cloud.google.com/stackdriver/docs/managed-prometheus/exporters/nvidia-dcgm?hl=zh-cn",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("NVIDIA 数据中心 GPU 管理器 (DCGM)  |  操作套件  |  Google Cloud")]),_:1})]),i("li",null,[a(n,{href:"https://blog.51cto.com/zaa47/2560477",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("GPU常见故障及排查方法_51CTO博客_GPU常见故障")]),_:1})]),i("li",null,[a(n,{href:"https://docs.nvidia.com/deploy/gpu-debug-guidelines/index.html",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("NVIDIA GPU Debug Guidelines - GPU Deployment and Management Documentation")]),_:1})]),i("li",null,[a(n,{href:"https://www.jimangel.io/posts/nvidia-rtx-gpu-kubernetes-setup/",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("A Practical Guide to Running NVIDIA GPUs on Kubernetes | jimangel.io")]),_:1})])]),i("p",null,[s("学习 "),Cs,s(" 在 Kubernetes 使用的时候发现了一个有意思的 AI 算力平台 "),a(n,{href:"https://openi.pcl.ac.cn/OpenI/Apulis-AI-Platform/commit/da673ab384cb6ea8a5276fad1ffc8695fe1d1d6d.diff",target:"_blank",rel:"noreferrer"},{default:h(()=>[s("openi.pcl.ac.cn/OpenI/Apulis-AI-Platform/commit/da673ab384cb6ea8a5276fad1ffc8695fe1d1d6d.diff")]),_:1})]),a(e),a(p)])}const vs=r(o,[["render",cs]]);export{_s as __pageData,vs as default};
