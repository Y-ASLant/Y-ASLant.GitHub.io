import{_ as d,c as r,I as a,j as s,a as i,w as e,au as l,D as t,o}from"./chunks/framework.RMxno62p.js";const w=JSON.parse('{"title":"在本地用 OpenSSL 用配置文件和版本控制的方式创建、配置和使用 Intermediate CA（中间 CA）","description":"","frontmatter":{"tags":["命令行/openssl","数学/密码学/证书","数学/密码学/证书/TLS","数学/密码学/证书/TLS/mTLS","数学/密码学/证书/TLS/HTTPS","数学/密码学/证书/TLS/SSL","数学/密码学/证书/PKI","数学/密码学/证书/证书机构/CA","开发/Git","命令行/git","数学/密码学/证书/证书机构/中间CA","数学/密码学/证书/证书机构/IntermediateCA","数学/密码学/证书/证书机构/RootCA","数学/密码学/证书/TLS/域名证书","数学/密码学/证书/证书吊销列表","数学/密码学/证书/证书吊销列表/CRL"]},"headers":[],"relativePath":"笔记/🔒 PKI 公钥基础设施/在本地用 OpenSSL 用配置文件和版本控制的方式创建、配置和使用 Intermediate CA（中间 CA）.md","filePath":"笔记/🔒 PKI 公钥基础设施/在本地用 OpenSSL 用配置文件和版本控制的方式创建、配置和使用 Intermediate CA（中间 CA）.md"}'),c={name:"笔记/🔒 PKI 公钥基础设施/在本地用 OpenSSL 用配置文件和版本控制的方式创建、配置和使用 Intermediate CA（中间 CA）.md"},g=s("h1",{id:"在本地用-openssl-用配置文件和版本控制的方式创建、配置和使用-intermediate-ca-中间-ca",tabindex:"-1"},[i("在本地用 OpenSSL 用配置文件和版本控制的方式创建、配置和使用 Intermediate CA（中间 CA） "),s("a",{class:"header-anchor",href:"#在本地用-openssl-用配置文件和版本控制的方式创建、配置和使用-intermediate-ca-中间-ca","aria-label":'Permalink to "在本地用 OpenSSL 用配置文件和版本控制的方式创建、配置和使用 Intermediate CA（中间 CA）"'},"​")],-1),y={class:"warning custom-block"},C=s("p",{class:"custom-block-title"},"⚠️ 开始前请阅读",-1),m=l("<blockquote><p>The ca command is quirky and at times downright unfriendly. ca 命令很古怪，有时甚至完全不友好。</p></blockquote><p>以及</p><blockquote><p>The ca utility was originally meant as an example of how to do things in a CA. It was not supposed to be used as a full blown CA itself: nevertheless some people are using it for this purpose.</p></blockquote><blockquote><p>ca 实用程序最初是作为如何在 CA 中执行操作的示例。它本身不应该被用作一个完整的 CA：尽管如此，还是有人将它用于此目的。</p></blockquote><blockquote><p>The ca command is effectively a single user command: no locking is done on the various files and attempts to run more than one ca command on the same database can have unpredictable results.</p></blockquote><blockquote><p>ca 命令实际上是一个单用户命令：不会对各个文件进行锁定，并且尝试在同一数据库上运行多个 ca 命令可能会产生不可预测的结果。</p></blockquote><p>所以这篇文档并不是推荐大家用 <code>openssl ca</code> 这样的命令去管理和维护自己的 CA 和下面的证书，而是希望提供一个方向和指南来说明 <code>openssl ca</code> 是如何运行和使用的，我也仅仅只有在自己的 Homelab 上的小部分领域使用了这样的方式来管理自己的 CA 和证书。</p>",7),F=l(`<div class="warning custom-block"><p class="custom-block-title">⚠️ 关于版本控制</p><p>在 2023 年这样的云原生时代下，我依然没有找到一个适合终端管理用户去使用的比较友好的 CA 管理工具，所以我在这里使用了 Git 作为版本控制工具来管理我的 CA 和证书。 这不代表我推荐你也这么做，生产环境上也不建议这么做，你在版本控制中也应该时时刻刻关注你的私钥是否被添加到了暂存，Stash，推送到了目标远程服务器，一旦你在 Git 历史中留下了任何的私钥的脚印，这将会引入非常大的安全隐患，允许黑客在入侵电脑后直接通过 Git Reflog 相关的命令直接把含有私钥的历史记录解析和提取出来。</p><p><strong>我这么做只是因为没有更好用直观的管理工具，且我自己使用类似于 1Password 这样的工具去细致地管理我的所有私钥，如果你也想这样实践和尝试 CA 和 PKI，请务必注意你的私钥的安全。</strong></p></div><h2 id="创建" tabindex="-1">创建 <a class="header-anchor" href="#创建" aria-label="Permalink to &quot;创建&quot;">​</a></h2><h3 id="创建存储中间-ca-相关所有文件的目录" tabindex="-1">创建存储中间 CA 相关所有文件的目录 <a class="header-anchor" href="#创建存储中间-ca-相关所有文件的目录" aria-label="Permalink to &quot;创建存储中间 CA 相关所有文件的目录&quot;">​</a></h3><p>我们可以在 Root CA 所在的目录下新建一个用于存储中间 CA 本身的各种配置文件，历史文件的目录：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains</span></span></code></pre></div><h3 id="创建-openssl-配置文件" tabindex="-1">创建 OpenSSL 配置文件 <a class="header-anchor" href="#创建-openssl-配置文件" aria-label="Permalink to &quot;创建 OpenSSL 配置文件&quot;">​</a></h3><p>在这个新创建的 <code>intermediates/domains</code> 下创建一个新的 OpenSSL 配置文件 <code>intermediates/domains/self_openssl.cnf</code> 来配置中间 CA 本身的元数据信息：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">touch</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/self_openssl.cnf</span></span></code></pre></div><p>然后填充下面的内容</p><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[req]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">distinguished_name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> req_distinguished_name</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[req_distinguished_name]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 配置基础信息的提示，这个不要删</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">countryName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">            =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 国家代号（两位字母）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stateOrProvinceName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 州/省</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">localityName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">           =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 市</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">0.organizationName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">     =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 组织名称</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">organizationalUnitName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 部门名称</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">commonName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">             =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 中间 CA 名称</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 配置默认值</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">countryName_default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">            =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> CN</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stateOrProvinceName_default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> Shanghai</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">localityName_default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">           =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> Shanghai</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">0.organizationName_default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">     =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> Ayaka Home Domains</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">organizationalUnitName_default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> Ayaka Home Domains</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">commonName_default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">             =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> Ayaka Home Domains Intermediate CA v1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 创建证书的时候需要激活的扩展</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[v3_intermediate_ca]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">subjectKeyIdentifier</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> hash</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">authorityKeyIdentifier</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> keyid:always,issuer</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 要注意的是，这里 pathlen 写了 0 是因为这个中间证书专门为了</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">basicConstraints</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> critical, CA:true, pathlen:0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">keyUsage</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> critical, digitalSignature, cRLSign, keyCertSign</span></span></code></pre></div><h3 id="创建创建证书需要的目录" tabindex="-1">创建创建证书需要的目录 <a class="header-anchor" href="#创建创建证书需要的目录" aria-label="Permalink to &quot;创建创建证书需要的目录&quot;">​</a></h3><p>我们在 <code>intermediates/domains/self_openssl.cnf</code> 的这个 OpenSSL 配置文件中指定的目录是需要预先创建和准备好的：</p><ol><li><code>private</code>：用于存储 Intermediate CA（中间证书）的私钥的目录</li><li><code>certs</code>：用于存储 Intermediate CA（中间证书）的目录</li><li><code>csr</code>：用于存储我们创建的 CSR（证书签发申请文件）</li></ol><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/private</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/certs</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/csr</span></span></code></pre></div><h3 id="创建和申请中间-ca" tabindex="-1">创建和申请中间 CA <a class="header-anchor" href="#创建和申请中间-ca" aria-label="Permalink to &quot;创建和申请中间 CA&quot;">​</a></h3><h4 id="创建私钥" tabindex="-1">创建私钥 <a class="header-anchor" href="#创建私钥" aria-label="Permalink to &quot;创建私钥&quot;">​</a></h4><div class="warning custom-block github-alert"><p class="custom-block-title">关于为什么文件命名后缀带有日期，以及 PKI 和版本控制</p><p>由于一般私钥是不纳入版本控制的，如果我们在本地同时拥有和需要管理多个私钥，甚至是在临时的部署中需要操作这些私钥的时候，如果只使用一个 <code>intermediate.key.pem</code> 作为命名的话可能之后需要涉及到来回重命名文件，所以在下面的命令中，我会偏好于在后缀中或者在文件夹中加入一个年份和月份来提示开发者和管理者操作的目标 key 和证书是什么时候生成的。</p></div><p>你可以执行下面的命令生成一个新的私钥：</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-zHEqV" id="tab-7wx-iLw" checked><label for="tab-7wx-iLw">使用 RSA 算法</label><input type="radio" name="group-zHEqV" id="tab-i1DNI_O"><label for="tab-i1DNI_O">使用 Secp256k1 算法</label></div><div class="blocks"><div class="language-shell vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> genrsa</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 4096</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/private/intermediate.202309.key.pem</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ecparam</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -genkey</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -name</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> secp256k1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/private/intermediate.202309.key.pem</span></span></code></pre></div></div></div><h4 id="创建-csr-证书签发申请文件" tabindex="-1">创建 CSR（证书签发申请文件） <a class="header-anchor" href="#创建-csr-证书签发申请文件" aria-label="Permalink to &quot;创建 CSR（证书签发申请文件）&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> req</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -new</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -sha256</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/self_openssl.cnf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -key</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/private/intermediate.202309.key.pem</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/csr/intermediate.202309.csr</span></span></code></pre></div><h4 id="使用-root-ca-根据-csr-签发证书" tabindex="-1">使用 Root CA 根据 CSR 签发证书 <a class="header-anchor" href="#使用-root-ca-根据-csr-签发证书" aria-label="Permalink to &quot;使用 Root CA 根据 CSR 签发证书&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ca</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> home_ca.cnf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -extensions</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> v3_intermediate_ca</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -days</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 3650</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -notext</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -md</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sha256</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -in</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/csr/intermediate.202309.csr</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/certs/intermediate.202309.crt</span></span></code></pre></div><p>结果：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ca</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> home_ca.cnf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -extensions</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> v3_intermediate_ca</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -days</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 3650</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -notext</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -md</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sha256</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -in</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/csr/intermediate.202309.csr</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/certs/intermediate.202309.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> configuration</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> home_ca.cnf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Check</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> that</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> request</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> matches</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> signature</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Signature</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">The</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Subject</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">s</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Distinguished</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Name</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> as</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> follows</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">countryName</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">           :PRINTABLE:&#39;CN&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">stateOrProvinceName</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   :ASN.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 12:&#39;Shanghai&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">localityName</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          :ASN.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 12:&#39;Shanghai&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">organizationName</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      :ASN.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 12:&#39;Ayaka Home Domains&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">organizationalUnitName:ASN.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 12:&#39;Ayaka Home Domains&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">commonName</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            :ASN.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 12:&#39;Ayaka Home Domains Intermediate CA v1&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">emailAddress</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          :IA5STRING:&#39;neko@ayaka.moe&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Certificate</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> be</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> certified</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> until</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Sep</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 25</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 13:44:32</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2033</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> GMT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (3650 </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">days</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Sign</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> certificate?</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [y/n]:y</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> of</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> certificate</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> requests</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> certified,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> commit?</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [y/n]y</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Write</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> database</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> new</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> entries</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Data</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Base</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Updated</span></span></code></pre></div><p>这个时候我们的中间 CA 证书就被创建好了，如果你前往 Root CA 的 <code>database</code> 字段中指向的文件（我这里是 <code>/opt/certs/home/index.txt</code>）中查看，会发现新增了一条：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span>V	330925162823Z		1010	unknown	/C=CN/ST=Shanghai/L=Shanghai/O=Ayaka Home Domains/OU=Ayaka Home Domains/CN=Ayaka Home Domains Intermediate CA v1/emailAddress=neko@ayaka.moe</span></span></code></pre></div><p>这个 <code>1009</code> 的数字就是我们证书的序列号了，你也可以在 Root CA 的 <code>serial</code> 字段所指向的文件（我这里是 <code>/opt/certs/home/serial</code>）文件中查看，它会变成下一个证书应该使用的序列号：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span>1010</span></span></code></pre></div><p>这个时候如果你不启用版本控制的话，就可以开始进行后续的操作了。如果你启用了版本控制，那我们可以把：</p><ul><li><code>self_openssl.cnf</code></li><li>生成的证书签名请求</li><li>签发的新证书</li><li>Root CA 附属的 <code>database</code> 对应的 <code>index.txt</code>，<code>index.txt.attr</code> 和 <code>index.txt.old</code></li><li><code>serial</code> 对应的 <code>serial</code>，<code>serial.old</code></li></ul><p>等以上文件都安全地添加到暂存中，然后提交到自己可信的 Repository 将他们存放起来方便之后我们参考和进行审计。</p><h2 id="配置" tabindex="-1">配置 <a class="header-anchor" href="#配置" aria-label="Permalink to &quot;配置&quot;">​</a></h2><h3 id="创建配置文件" tabindex="-1">创建配置文件 <a class="header-anchor" href="#创建配置文件" aria-label="Permalink to &quot;创建配置文件&quot;">​</a></h3><p>我们可以在先前新创建的 <code>intermediates/domains</code> 下创建一个用于中间 CA 创建证书的时候使用的新的 OpenSSL 配置文件 <code>intermediates/domains/issuer_openssl.cnf</code></p><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[ ca ]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># \`man ca\`</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">default_ca</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> CA_default</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[CA_default]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># dir 这个字段这里改成中间 CA 所收录的目录所在的位置哦</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 我这里因为是专门给域名相关的操作单开了一个中间 CA 所以开了一个 domains</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 的目录放在 intermediates 下面方便操作</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">dir</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">             =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> ./intermediates/domains</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private_key</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">     =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> $dir/private/intermediate.202309.key.pem </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 这个文件名注意要和我们创建的必须一致</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">certificate</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">     =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> $dir/certs/intermediate.202309.crt </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 中间的时间注意和我们创建的必须一致</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 因为这个文件是随着时间不断新增和配置的，理论上要么纳入到版本控制中，要么</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 上传和同步到 OSS 是最好的，方便分发到终端并方便终端网关和设备进行鉴权控制</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">crl</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">             =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> $dir/crl/intermediate.crl</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">database</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> $dir/index.txt</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">new_certs_dir</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">   =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> $dir/domains/certs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">serial</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">          =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> $dir/serial</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">policy</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">          =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> policy_intermediate</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 因为我们接下来都会在证书的 CSR 当中直接包含拓展信息，比如</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># subjectAltName，所以这里需要指明我们需要将拓展复制到签发</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 的证书中</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">copy_extensions</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> copy</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 配置一下中间 CA 之下的策略</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[policy_intermediate]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">countryName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">             =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> optional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stateOrProvinceName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">     =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> optional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">localityName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">            =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> optional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">organizationName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> optional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">organizationalUnitName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> optional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">commonName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">              =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> supplied</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">emailAddress</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">            =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> optional</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 服务端证书（HTTPS 证书，mTLS 服务端侧证书）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[server_cert_ext]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">authorityKeyIdentifier</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> keyid,issuer:always</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">basicConstraints</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">       =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> CA:FALSE</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">keyUsage</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">               =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> critical, digitalSignature, keyEncipherment</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">extendedKeyUsage</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">       =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> serverAuth </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 如果不需要 mTLS 的话可以注释掉这行</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">nsCertType</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">             =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> server </span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 如果不需要 mTLS 的话可以注释掉这行</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">subjectKeyIdentifier</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">   =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> hash</span></span></code></pre></div><h3 id="创建配置文件中关联的其他目录" tabindex="-1">创建配置文件中关联的其他目录 <a class="header-anchor" href="#创建配置文件中关联的其他目录" aria-label="Permalink to &quot;创建配置文件中关联的其他目录&quot;">​</a></h3><p>我们在 <code>intermediates/domains/issuer_openssl.cnf</code> 的这个 OpenSSL 配置文件中指定的目录是需要预先创建和准备好的：</p><ol><li><code>domains</code>：新的域名证书将会被存放的目录（因为我这里是以域名业务作为例子嘛所以这里你可以改成自己需要的目录名称，保持和 <code>intermediates/domains/self_openssl.cnf</code> 中的 <code>newcerts</code> 配置项一致就好了）</li><li><code>crl</code>：用于存储 CRL（证书吊销列表）文件的目录</li></ol><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/crl</span></span></code></pre></div><h3 id="初始化相关文件" tabindex="-1">初始化相关文件 <a class="header-anchor" href="#初始化相关文件" aria-label="Permalink to &quot;初始化相关文件&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">touch</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/index.txt</span></span></code></pre></div><p>因为我们签署的是相同 subject 内容的域名证书，所以这里我们需要在签署用的中间 CA 所在的目录下创建 <code>index.txt.attr</code> 文件并添加 <code>unique_subject = no</code></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;unique_subject = no&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/index.txt.attr</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1000</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/serial</span></span></code></pre></div><h2 id="使用" tabindex="-1">使用 <a class="header-anchor" href="#使用" aria-label="Permalink to &quot;使用&quot;">​</a></h2><h3 id="签发域名和泛域名证书" tabindex="-1">签发域名和泛域名证书 <a class="header-anchor" href="#签发域名和泛域名证书" aria-label="Permalink to &quot;签发域名和泛域名证书&quot;">​</a></h3><p>接下来我们给 <code>ihome.cat</code> 创建域名证书吧。</p><h4 id="准备域名目录" tabindex="-1">准备域名目录 <a class="header-anchor" href="#准备域名目录" aria-label="Permalink to &quot;准备域名目录&quot;">​</a></h4><p>域名需要方便我们针对文件夹进行打包和部署，所以这里我们使用 2023 作为目录名称而不是像之前一样使用时间后缀作为文件名的一部分：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023</span></span></code></pre></div><h4 id="创建目标终端证书的私钥" tabindex="-1">创建目标终端证书的私钥 <a class="header-anchor" href="#创建目标终端证书的私钥" aria-label="Permalink to &quot;创建目标终端证书的私钥&quot;">​</a></h4><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-8IXDG" id="tab-rc39t3M" checked><label for="tab-rc39t3M">使用 RSA 算法</label><input type="radio" name="group-8IXDG" id="tab-vJiFw0m"><label for="tab-vJiFw0m">使用 Secp256k1 算法</label></div><div class="blocks"><div class="language-shell vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> genrsa</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 4096</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.key.pem</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ecparam</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -genkey</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -name</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> secp256k1</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.key.pem</span></span></code></pre></div></div></div><h4 id="创建域名证书的-csr-证书签发申请文件" tabindex="-1">创建域名证书的 CSR（证书签发申请文件） <a class="header-anchor" href="#创建域名证书的-csr-证书签发申请文件" aria-label="Permalink to &quot;创建域名证书的 CSR（证书签发申请文件）&quot;">​</a></h4><p>创建一个域名专属的配置文件 <code>intermediates/domains/domains/ihome.cat/ihome.cat.cnf</code>：</p><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[req]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">req_extensions</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">     =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> v3_req</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">distinguished_name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> req_distinguished_name</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[req_distinguished_name]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 配置基础信息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">countryName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">            =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 国家代号（两位字母）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stateOrProvinceName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 州/省</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">localityName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">           =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 市</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">0.organizationName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">     =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 组织名称</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">organizationalUnitName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 部门名称</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">commonName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">             =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 域名</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">emailAddress</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">           =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> 联系邮箱</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 配置默认值</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">countryName_default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">            =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> CN</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">stateOrProvinceName_default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> Shanghai</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">localityName_default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">           =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> Shanghai</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">0.organizationName_default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">     =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> Ayaka Home Domains</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">organizationalUnitName_default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> Ayaka Home Domains</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">commonName_default</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">             =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> ihome.cat</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[v3_req]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">subjectAltName</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> @alt_names</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">[alt_names]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DNS.1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> *.ihome.cat</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DNS.2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#98C379;"> ihome.cat</span></span></code></pre></div><p>然后搭配 <code>-noout</code> 和 <code>-text</code> 参数预览一下 CSR 文件吧：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> req</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -new</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -sha256</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/ihome.cat.cnf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -key</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.key.pem</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -extensions</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> v3_req</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -noout</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -text</span></span></code></pre></div><p>如果没问题了就可以继续创建了：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> req</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -new</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -sha256</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/ihome.cat.cnf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -key</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.key.pem</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.csr</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -extensions</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> v3_req</span></span></code></pre></div><h4 id="签发域名证书" tabindex="-1">签发域名证书 <a class="header-anchor" href="#签发域名证书" aria-label="Permalink to &quot;签发域名证书&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ca</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -days</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 365</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -notext</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -md</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sha256</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/issuer_openssl.cnf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -extensions</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> server_cert_ext</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -in</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.csr</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.crt</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -verbose</span></span></code></pre></div><h4 id="查看域名证书" tabindex="-1">查看域名证书 <a class="header-anchor" href="#查看域名证书" aria-label="Permalink to &quot;查看域名证书&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> x509</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -in</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.crt</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -noout</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -text</span></span></code></pre></div><h4 id="打包为-p12" tabindex="-1">打包为 P12 <a class="header-anchor" href="#打包为-p12" aria-label="Permalink to &quot;打包为 P12&quot;">​</a></h4><p>如果你还需要在 Windows 上部署的话，可以在这个时候打包为 p12 证书：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pkcs12</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -export</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -in</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.crt</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -inkey</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.key.pem</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -certfile</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/certs/intermediate.202309.bundle.crt</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.p12</span></span></code></pre></div><h2 id="问题排查" tabindex="-1">问题排查 <a class="header-anchor" href="#问题排查" aria-label="Permalink to &quot;问题排查&quot;">​</a></h2><h3 id="variable-lookup-failed-for-ca-default-ca" tabindex="-1"><code>variable lookup failed for ca::default_ca</code> <a class="header-anchor" href="#variable-lookup-failed-for-ca-default-ca" aria-label="Permalink to &quot;\`variable lookup failed for ca::default_ca\`&quot;">​</a></h3><p>完整输出：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ca</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -days</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 375</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -notext</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -md</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sha256</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/ihome.cat.cnf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -extensions</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> server_cert_ext</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -in</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.csr</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> configuration</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/ihome.cat.cnf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">variable</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> lookup</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> failed</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ca::default_ca</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">8493538816:error:0EFFF06C:configuration</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> routines:CRYPTO_internal:no</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> value:/AppleInternal/Library/BuildRoots/c2cb9645-dafc-11ed-aa26-6ec1e3b3f7b3/Library/Caches/com.apple.xbs/Sources/libressl/libressl-3.3/crypto/conf/conf_lib.c:322:group=ca</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> name=default_ca</span></span></code></pre></div><p>是不是配置错文件了，签发证书的时候需要的是中间 CA 或者 Root CA 的配置文件，不是域名的配置文件。</p><h3 id="wrong-number-of-fields-on-line-1" tabindex="-1"><code>wrong number of fields on line 1</code> <a class="header-anchor" href="#wrong-number-of-fields-on-line-1" aria-label="Permalink to &quot;\`wrong number of fields on line 1\`&quot;">​</a></h3><p>完整输出：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ca</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -days</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 375</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -notext</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -md</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sha256</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/issuer_openssl.cnf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -extensions</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> server_cert_ext</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -in</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.csr</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> configuration</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> home_ca.cnf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">wrong</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> number</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fields</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> line</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (looking </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> field</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 6,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> got</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 1,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> left</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span></code></pre></div><p>是不是修改了 <code>database.txt</code> 之后出现多行少行或者 Tab？<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p><h3 id="txt-db-error-number-2" tabindex="-1"><code>TXT_DB error number 2</code> <a class="header-anchor" href="#txt-db-error-number-2" aria-label="Permalink to &quot;\`TXT_DB error number 2\`&quot;">​</a></h3><p>完整输出：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ca</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -days</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 365</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -notext</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -md</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sha256</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/issuer_openssl.cnf</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -extensions</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> server_cert_ext</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -in</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.csr</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/domains/ihome.cat/2023/ihome.cat.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> configuration</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> intermediates/domains/issuer_openssl.cnf</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Check</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> that</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> request</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> matches</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> signature</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Signature</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ok</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">The</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Subject</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">s</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Distinguished</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Name</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> as</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> follows</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">countryName</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">           :PRINTABLE:&#39;CN&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">stateOrProvinceName</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   :ASN.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 12:&#39;Shanghai&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">localityName</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          :ASN.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 12:&#39;Shanghai&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">organizationName</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">      :ASN.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 12:&#39;Ayaka Home Domains&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">organizationalUnitName:ASN.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 12:&#39;Ayaka Home Domains&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">commonName</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            :ASN.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 12:&#39;ihome.cat&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">emailAddress</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          :IA5STRING:&#39;neko@ayaka.moe&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Certificate</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> be</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> certified</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> until</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Sep</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 28</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 04:51:42</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2024</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> GMT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (365 </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">days</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Sign</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> certificate?</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [y/n]:y</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">failed</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> update</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> database</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">TXT_DB</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> error</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> number</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2</span></span></code></pre></div><p>因为我们签署的是相同 subject 内容的域名证书，所以这里我们需要在签署用的中间 CA 所在的目录下的 <code>index.txt.attr</code>（如果没有的话直接创建就好了）中添加</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span>unique_subject = no</span></span></code></pre></div><p>这样的配置。</p><h2 id="延伸阅读" tabindex="-1">延伸阅读 <a class="header-anchor" href="#延伸阅读" aria-label="Permalink to &quot;延伸阅读&quot;">​</a></h2>`,83),A=s("hr",{class:"footnotes-sep"},null,-1),u={class:"footnotes"},D={class:"footnotes-list"},b={id:"fn1",class:"footnote-item"},f=s("a",{href:"#fnref1",class:"footnote-backref"},"↩︎",-1);function v(E,B,_,S,x,N){const h=t("NolebasePageProperties"),n=t("VPNolebaseInlineLinkPreview"),p=t("NolebaseGitContributors"),k=t("NolebaseGitChangelog");return o(),r("div",null,[g,a(h),s("div",y,[C,s("p",null,[i("正如"),a(n,{href:"https://www.openssl.org/docs/man1.1.1/man1/ca.html",target:"_blank",rel:"noreferrer"},{default:e(()=>[i("官方文档")]),_:1}),i("所述：")]),m,s("p",null,[i("如果你喜欢的话，你大可以理解为这是一种「古法手搓 CA 和证书」的行为，而非生产环境中建议的行为，这很 Geek，需要你了解你在做什么。我建议你在学习和实操之后多阅读阅读"),a(n,{href:"https://www.openssl.org/docs/man1.1.1/man1/ca.html",target:"_blank",rel:"noreferrer"},{default:e(()=>[i("官方文档")]),_:1}),i("的警告部分。")])]),F,s("p",null,[a(n,{href:"https://two-oes.medium.com/implementing-mtls-with-apache-and-openssl-on-openshift-31719be13e7a",target:"_blank",rel:"noreferrer"},{default:e(()=>[i("Implementing MTLS with Apache and OpenSSL on OpenShift | by Oren Oichman | Medium")]),_:1})]),s("p",null,[a(n,{href:"https://jamielinux.com/docs/openssl-certificate-authority/create-the-intermediate-pair.html",target:"_blank",rel:"noreferrer"},{default:e(()=>[i("Create the intermediate pair — OpenSSL Certificate Authority — Jamie Nguyen")]),_:1})]),s("p",null,[a(n,{href:"https://jamielinux.com/docs/openssl-certificate-authority/appendix/intermediate-configuration-file.html",target:"_blank",rel:"noreferrer"},{default:e(()=>[i("Intermediate CA configuration file — OpenSSL Certificate Authority — Jamie Nguyen")]),_:1})]),s("p",null,[a(n,{href:"https://www.openssl.org/docs/man1.1.1/man5/config.html",target:"_blank",rel:"noreferrer"},{default:e(()=>[i("/docs/man1.1.1/man5/config.html OpenSSL")]),_:1})]),s("p",null,[a(n,{href:"https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs",target:"_blank",rel:"noreferrer"},{default:e(()=>[i("OpenSSL Essentials: Working with SSL Certificates, Private Keys and CSRs | DigitalOcean")]),_:1})]),s("p",null,[a(n,{href:"https://runsisi.com/2019/12/11/cert/",target:"_blank",rel:"noreferrer"},{default:e(()=>[i("SSL/TLS 自签名证书")]),_:1})]),s("p",null,[a(n,{href:"https://www.phildev.net/ssl/opensslconf.html",target:"_blank",rel:"noreferrer"},{default:e(()=>[i("Openssl.conf")]),_:1})]),s("p",null,[a(n,{href:"https://www.phildev.net/ssl/managing_ca.html",target:"_blank",rel:"noreferrer"},{default:e(()=>[i("Managing a CA")]),_:1})]),a(p),a(k),A,s("section",u,[s("ol",D,[s("li",b,[s("p",null,[a(n,{href:"https://stackoverflow.com/questions/33503190/wrong-number-of-fields-with-openssl",target:"_blank",rel:"noreferrer"},{default:e(()=>[i("indexing - Wrong number of fields with openssl - Stack Overflow")]),_:1}),i(),f])])])])])}const P=d(c,[["render",v]]);export{w as __pageData,P as default};
