import{_ as p,c as r,I as a,j as i,w as t,a as s,au as d,D as h,o}from"./chunks/framework.RMxno62p.js";const w=JSON.parse('{"title":"一个因为系统没有重启应用更新导致的 Docker 无法启动的乌龙","description":"","frontmatter":{"tags":["命令行/docker","软件/云原生/docker","运维/内核","运维/云原生/Docker","操作系统/Debian","操作系统/Debian/Debian-12","命令行/containerd","软件/云原生/containerd","操作系统/Unix","计算机/操作系统/Linux","计算机/操作系统/Linux/内核","计算机/操作系统/Linux/命令行","操作系统/Linux","开发/故障排查","运维/云原生/Kubernetes"]},"headers":[],"relativePath":"笔记/🧱 基础设施/一个因为系统没有重启应用更新导致的 Docker 无法启动的乌龙.md","filePath":"笔记/🧱 基础设施/一个因为系统没有重启应用更新导致的 Docker 无法启动的乌龙.md"}'),g={name:"笔记/🧱 基础设施/一个因为系统没有重启应用更新导致的 Docker 无法启动的乌龙.md"},F=i("h1",{id:"一个因为系统没有重启应用更新导致的-docker-无法启动的乌龙",tabindex:"-1"},[s("一个因为系统没有重启应用更新导致的 Docker 无法启动的乌龙 "),i("a",{class:"header-anchor",href:"#一个因为系统没有重启应用更新导致的-docker-无法启动的乌龙","aria-label":'Permalink to "一个因为系统没有重启应用更新导致的 Docker 无法启动的乌龙"'},"​")],-1),y=d(`<h2 id="背景" tabindex="-1">背景 <a class="header-anchor" href="#背景" aria-label="Permalink to &quot;背景&quot;">​</a></h2><p>今天有个伙伴问 Docker 的网络故障的问题，就想着正好最近天天看 Docker 和 containerd 的代码和社区，来帮忙 debug 看看好了...</p><p>首先系统是这样的</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -r</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">6.1.0-10-amd64</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -a</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Linux</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 6.1.0-10-amd64</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> #1 SMP PREEMPT_DYNAMIC Debian 6.1.38-1 (2023-07-14) x86_64 GNU/Linux</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> lsb_release</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -a</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> LSB</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> modules</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> are</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> available.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Distributor</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ID:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">	Debian</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Description:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">	Debian</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> GNU/Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 12</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (bookworm)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Release:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">	12</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Codename:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">	bookworm</span></span></code></pre></div><p>在重启了 Docker 的 Systemd 服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> docker</span></span></code></pre></div><p>之后发现报错了，报错的日志输出是这样的</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> journalctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -xeu</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> docker.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 09:22:20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dockerd[352906]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> failed</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> daemon:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Error</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> initializing</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> network</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> controller:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Error</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> creating</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;bridge&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> network:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Failed</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Setup</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> IP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> tables:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Unable</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> NAT</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rule:</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  (iptables </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">failed:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --wait</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -I</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> POSTROUTING</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 172.17.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> !</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> docker0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> MASQUERADE:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Warning:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Extension</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> MASQUERADE</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> revision</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> not</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> supported,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> missing</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> module?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 09:22:20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dockerd[352906]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> iptables</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> v1.8.9</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (nf_tables):  CHAIN_ADD failed (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> such</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> or</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> directory</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">): chain POSTROUTING</span></span></code></pre></div><p>单拎出来这段 <code>iptables</code> 的命令可以看到这个报错确实是这样的</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --wait</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -I</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> POSTROUTING</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 172.17.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> !</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> docker0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> MASQUERADE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">iptables</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> v1.8.9</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (nf_tables):  CHAIN_ADD failed (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> such</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> or</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> directory</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">): chain POSTROUTING</span></span></code></pre></div><h2 id="调查" tabindex="-1">调查 <a class="header-anchor" href="#调查" aria-label="Permalink to &quot;调查&quot;">​</a></h2><p>那么，<code>containerd</code> 在正常运行吗</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">●</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd.service</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> container</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> runtime</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     Loaded:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> loaded</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (/lib/systemd/system/containerd.service; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">preset:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     Active:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> active</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (running) since Wed 2023-12-13 08:36:21 UTC; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">19min</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       Docs:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https://containerd.io</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   Main</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> PID:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 350077</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (containerd)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      Tasks:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 6</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     Memory:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 20.8M</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">        CPU:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 3.222s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     CGroup:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /system.slice/containerd.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             └─350077</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /usr/bin/containerd</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:36:21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd[350077]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T08:36:21.662772162Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=serving...</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> address=/run/containerd/containerd.sock.ttrpc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:36:21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd[350077]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T08:36:21.662831919Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=serving...</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> address=/run/containerd/containerd.sock</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:36:21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd[350077]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T08:36:21.668808237Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=&quot;Start subscribing containerd event&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:36:21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd[350077]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T08:36:21.668851196Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=&quot;Start recovering state&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:36:21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd[350077]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T08:36:21.668938818Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=&quot;Start event monitor&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:36:21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd[350077]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T08:36:21.668970047Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=&quot;Start snapshots syncer&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:36:21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd[350077]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T08:36:21.668996641Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=&quot;Start cni network conf syncer for default&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:36:21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd[350077]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T08:36:21.669006911Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=&quot;Start streaming server&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:36:21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> systemd[1]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Started</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd.service</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> container</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> runtime.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 08:36:21</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containerd[350077]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T08:36:21.688811231Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=&quot;containerd successfully booted in 0.069185s&quot;</span></span></code></pre></div><p>据说这个和 <code>debian</code> 用的 <code>iptables</code> 的 <code>nftables</code> 替代有关<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>，如果用</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> update-alternatives</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> iptables</span></span></code></pre></div><p>就可以观察到现在的 <code>iptables</code> 模块背后的选择</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> update-alternatives</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> iptables</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">There</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> are</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> choices</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> alternative</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> iptables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (providing </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/usr/sbin/iptables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">).</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Selection</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Path</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                       Priority</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            /usr/sbin/iptables-nft</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        auto</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mode</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            /usr/sbin/iptables-legacy</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   10</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        manual</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mode</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 2            /usr/sbin/iptables-nft      20        manual mode</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Press</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">ente</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> keep</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> current</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> choice[</span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">],</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> or</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> type</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> selection</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> number:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">update-alternatives:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /usr/sbin/iptables-legacy</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> provide</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /usr/sbin/iptables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (iptables) in manual mode</span></span></code></pre></div><p>再次执行看看有没有应用生效了</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> update-alternatives</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> iptables</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">There</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> are</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> choices</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> alternative</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> iptables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (providing </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/usr/sbin/iptables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">).</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Selection</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Path</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                       Priority</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            /usr/sbin/iptables-nft</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        auto</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mode</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 1            /usr/sbin/iptables-legacy   10        manual mode</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            /usr/sbin/iptables-nft</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        manual</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mode</span></span></code></pre></div><p>然后再执行一次看看结果：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --wait</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -I</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> POSTROUTING</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 172.170.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> !</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> docker0</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> MASQUERADE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Warning:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Extension</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> MASQUERADE</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> revision</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> not</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> supported,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> missing</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> module?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">iptables</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> v1.8.9</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (legacy): can</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;t initialize iptables table \`nat&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: Table does not exist (do you need to insmod</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Perhaps</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> iptables</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> or</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> your</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> needs</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> be</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> upgraded.</span></span></code></pre></div><p>看起来已经是 <code>iptables</code> <code>legacy</code> 了，但是出现了新的报错</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">iptables</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> v1.8.9</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (legacy): can</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;t initialize iptables table \`nat&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: Table does not exist (do you need to insmod</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span></code></pre></div><p>那这个时候，内核模块正常吗？我之前确实没有检查过。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> modprobe</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ip_tables</span></span></code></pre></div><p>没有输出。</p><p>不过既然是 NAT 报错，那会是没有配置相关的转发模块吗？</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /boot/config-</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -r</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> CONFIG_IP_NF_NAT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">CONFIG_IP_NF_NAT</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">m</span></span></code></pre></div><div class="tip custom-block github-alert"><p class="custom-block-title">查看单独的内核模块信息</p><p></p><p>看了看 <code>modinfo</code> 的输出，看起来基本的模块是在的，能返回</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">modinfo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nf_nat_ipv4</span></span></code></pre></div></div><div class="tip custom-block github-alert"><p class="custom-block-title">查看完整的内核模块</p><p></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ls</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /lib/modules/</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -r</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/kernel/net/netfilter/</span></span></code></pre></div><p>查看 IPv4 相关的模块</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ls</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /lib/modules/</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -r</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/kernel/net/ipv4/netfilter/</span></span></code></pre></div></div><p>然后在看别人的帖子的时候看到说这个和 <code>nf_nat_ipv4</code> 有关，这个时候用 <code>modprobe</code> 观察就可以发现 <code>nf_nat_ipv4</code> 缺失了：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> modprobe</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nf_nat_ipv4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">modprobe:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> FATAL:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Module</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> nf_nat_ipv4</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> not</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> found</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> directory</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /lib/modules/6.1.0-10-amd64</span></span></code></pre></div><h2 id="修复" tabindex="-1">修复 <a class="header-anchor" href="#修复" aria-label="Permalink to &quot;修复&quot;">​</a></h2><p>这下我摸不着头脑了，直到我看到一篇上古的在 2016 年的帖子给了我醍醐灌顶的一击：</p><blockquote><p>Another possible problem with the same symptoms is stale kernel running - after upgrade and before reboot. This is the one I encountered just now.<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></p></blockquote><p>然后我就恍然大悟了。对啊！内核更新的时候可能会发生配置选项和路径变更，这个时候可能跑在一个过时的内核上，这个时候 Docker 和 <code>iptables</code> 异常都是非常正常的事情，还有可能发生别的更复杂的情况。</p><p>为了验证这个情况，通过</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> reboot</span></span></code></pre></div><p>重启之后发现 Docker 已经恢复正常了：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> $</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> docker</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">●</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> docker.service</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Docker</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Application</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Container</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Engine</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     Loaded:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> loaded</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (/lib/systemd/system/docker.service; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">preset:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     Active:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> active</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (running) since Wed 2023-12-13 09:47:09 UTC; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">6s</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ago</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">TriggeredBy:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ●</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> docker.socket</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">       Docs:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https://docs.docker.com</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   Main</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> PID:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1025</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (dockerd)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      Tasks:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     Memory:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 27.7M</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">        CPU:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 237ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">     CGroup:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /system.slice/docker.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">             └─1025</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /usr/sbin/dockerd</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -H</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> fd://</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --containerd=/run/containerd/containerd.sock</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 09:47:09</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dockerd[1025]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T09:47:09.285808913Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=&quot;[core] Subchannel Connectivity change to READY&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> module=grpc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 09:47:09</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dockerd[1025]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T09:47:09.285894457Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=&quot;[core] Channel Connectivity change to READY&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> module=grpc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 09:47:09</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dockerd[1025]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T09:47:09.300511903Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=&quot;[graphdriver] using prior storage driver: overlay2&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 09:47:09</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dockerd[1025]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T09:47:09.303744784Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=&quot;Loading containers: start.&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 09:47:09</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dockerd[1025]:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time=&quot;2023-12-13T09:47:09.489257121Z&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> level=info</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> msg=&quot;Default bridge (docker0) is assigned with an IP address 172.17.0.0/16. Daemon option --bip can be&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">Dec 13 09:47:09 localhost dockerd[1025]: time=&quot;2023-12-13T09:47:09.536110748Z&quot; level=info msg=&quot;Loading</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> containers:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> done.&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">Dec 13 09:47:09 localhost dockerd[1025]: time=&quot;2023-12-13T09:47:09.553699433Z&quot; level=info msg=&quot;Docker</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> daemon&quot; commit=5d6db84 graphdriver(s)=overlay2 version=20.10.24+dfsg1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">Dec 13 09:47:09 localhost dockerd[1025]: time=&quot;2023-12-13T09:47:09.553920794Z&quot; level=info msg=&quot;Daemon</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> has</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> completed</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> initialization&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">Dec 13 09:47:09 localhost systemd[1]: Started docker.service - Docker Application Container Engine.</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">Dec 13 09:47:09 localhost dockerd[1025]: time=&quot;2023-12-13T09:47:09.592818728Z&quot; level=info msg=&quot;API</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> listen</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /run/docker.sock&quot;</span></span></code></pre></div><p>为了确保不会弄错，我又去修改了一下 <code>iptables</code> 的系统软件替换选项：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> update-alternatives</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> iptables</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">There</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> are</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> choices</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> alternative</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> iptables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (providing </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">/usr/sbin/iptables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">).</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  Selection</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Path</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                       Priority</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            /usr/sbin/iptables-nft</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        auto</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mode</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> 1            /usr/sbin/iptables-legacy   10        manual mode</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            /usr/sbin/iptables-nft</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">      20</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        manual</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mode</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Press</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">ente</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> keep</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> current</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> choice[</span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">],</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> or</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> type</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> selection</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> number:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">update-alternatives:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> using</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /usr/sbin/iptables-nft</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> provide</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /usr/sbin/iptables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (iptables) in manual mode</span></span></code></pre></div><p>然后执行</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> docker</span></span></code></pre></div><p>发现 Docker 依然是正常的，这意味着之前的探索路线应该是错误了。</p><p>考虑到可能容器运行时或者 Docker API 有问题，我跑了一个很常见的 busybox 的容器并且进行了简单的网络测试：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> docker</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -it</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --rm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> busybox</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Unable</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> find</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> image</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;busybox:latest&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> locally</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">latest:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Pulling</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> library/busybox</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">6672f60b6ba8:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Pull</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> complete</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Digest:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sha256:1ceb872bcc68a8fcd34c97952658b58086affdcb604c90c1dee2735bde5edc2f</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Status:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Downloaded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> newer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> image</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> busybox:latest</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> #</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> #</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">/</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # nslookup google.com</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Server:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">		108.61.10.10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Address:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">	108.61.10.10:53</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Non-authoritative</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> answer:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Name:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">	google.com</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Address:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 142.250.72.238</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Non-authoritative</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> answer:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Name:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">	google.com</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Address:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 2607:f8b0:4007:816::200e</span></span></code></pre></div><p>发现都是正常的了。</p><h2 id="结论" tabindex="-1">结论 <a class="header-anchor" href="#结论" aria-label="Permalink to &quot;结论&quot;">​</a></h2><p>看起来就是一个更新系统之后没有重启的乌龙 😂。</p><p>这个故事告诫我们要在重要系统更新之后重启系统，如果是云服务商自动更新的，也要记得通知客户然后重启系统，避免这样的尴尬局面 😂。</p><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to &quot;参考资料&quot;">​</a></h2>`,54),C=i("hr",{class:"footnotes-sep"},null,-1),c={class:"footnotes"},u={class:"footnotes-list"},b={id:"fn1",class:"footnote-item"},A=i("code",null,"nftables",-1),m=i("code",null,"nftables",-1),v=i("code",null,"nftables",-1),E=i("a",{href:"#fnref1",class:"footnote-backref"},"↩︎",-1),f={id:"fn2",class:"footnote-item"},D=i("a",{href:"#fnref2",class:"footnote-backref"},"↩︎",-1);function B(_,q,x,T,P,N){const l=h("NolebasePageProperties"),n=h("VPNolebaseInlineLinkPreview"),k=h("NolebaseGitContributors"),e=h("NolebaseGitChangelog");return o(),r("div",null,[F,a(l),y,i("ul",null,[i("li",null,[a(n,{href:"https://stackoverflow.com/questions/21983554/iptables-v1-4-14-cant-initialize-iptables-table-nat-table-does-not-exist-d",target:"_blank",rel:"noreferrer"},{default:t(()=>[s("linux kernel - Iptables v1.4.14: can't initialize iptables table `nat': Table does not exist (do you need to insmod?) - Stack Overflow")]),_:1})])]),a(k),a(e),C,i("section",c,[i("ol",u,[i("li",b,[i("p",null,[s("在 "),a(n,{href:"https://github.com/firewalld/firewalld/issues/1184",target:"_blank",rel:"noreferrer"},{default:t(()=>[s("Fails on completely new Debian 12 server · Issue #1184 · firewalld/firewalld")]),_:1}),s("，"),a(n,{href:"https://serverfault.com/questions/1140935/firewalld-fails-on-completely-new-debian-12-server",target:"_blank",rel:"noreferrer"},{default:t(()=>[s("Firewalld fails on completely new Debian 12 server - Server Fault")]),_:1}),s("（其实是同一个人发的帖子），"),a(n,{href:"https://fishros.org.cn/forum/topic/1147/docker-arm64-error-creating-default-bridge-network-iptables-v1-8-7-nf_tables-chain_add-failed-no-such-file-or-directory-chain-postrouting",target:"_blank",rel:"noreferrer"},{default:t(()=>[s('docker arm64 Error creating default "bridge" network iptables v1.8.7 (nf_tables): CHAIN_ADD failed (No such file or directory): chain POSTROUTING | 鱼香ROS')]),_:1}),s(" 和 "),a(n,{href:"https://blog.csdn.net/choumin/article/details/111935589",target:"_blank",rel:"noreferrer"},{default:t(()=>[s("Chain ‘MASQUERADE‘ does not exist 报错解决_chain 'masquerade' does not exist-CSDN博客")]),_:1}),s(" 这几篇帖子中都提及了 "),A,s(" 与 Docker 不兼容的问题。考虑到我还真的不熟悉 "),m,s("，又去查了点资料，发现 Docker 以前的上游 Moby 是不支持的，参见 "),a(n,{href:"https://github.com/moby/moby/issues/26824",target:"_blank",rel:"noreferrer"},{default:t(()=>[s("[feature request] nftables support · Issue #26824 · moby/moby")]),_:1}),s("，因此我又去找了 "),v,s(" 和 Docker 一起强行使用的教学文档，确实有很多，比如 "),a(n,{href:"https://max.sodawa.com/blog/nftables-and-docker/",target:"_blank",rel:"noreferrer"},{default:t(()=>[s("debian, docker and nftables")]),_:1}),s(" 和 "),a(n,{href:"https://gist.github.com/goll/bdd6b43c2023f82d15729e9b0067de60",target:"_blank",rel:"noreferrer"},{default:t(()=>[s("Docker nftables configuration for Debian 10")]),_:1}),s("，"),a(n,{href:"https://github.com/alexandre-khoury/blog/tree/main/posts/docker-nftables",target:"_blank",rel:"noreferrer"},{default:t(()=>[s("blog/posts/docker-nftables")]),_:1}),s(" 都有比较详尽的介绍 "),E])]),i("li",f,[i("p",null,[s("在 "),a(n,{href:"https://bbs.archlinux.org/viewtopic.php?id=182400",target:"_blank",rel:"noreferrer"},{default:t(()=>[s("[SOLVED] iptables table NAT: Table does not exist (do ... to insmod?) / Newbie Corner / Arch Linux Forums")]),_:1}),s(" 帖子里面的评论 "),D])])])])])}const I=p(g,[["render",B]]);export{w as __pageData,I as default};
