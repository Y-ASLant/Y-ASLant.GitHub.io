import{_ as r,c as d,I as a,j as s,w as l,a as i,au as t,D as e,o}from"./chunks/framework.RMxno62p.js";const Fs=JSON.parse('{"title":"在 Kubeadm 部署的 Kubernetes 集群中安装 Cilium","description":"","frontmatter":{"tags":["运维/云原生/Kubernetes","运维/云原生/Kubernetes/K8s","开发/云原生/Kubernetes/K8s","开发/云原生/Kubernetes","运维/Cilium","命令行/cilium","软件/云原生/Cilium","命令行/kubeadm","软件/云原生/kubeadm","软件/云原生/kube-proxy","计算机/网络/Cilium","命令行/helm","软件/云原生/helm","开发/标记语言/YAML"]},"headers":[],"relativePath":"笔记/🧱 基础设施/🚢 Kubernetes/在 Kubeadm 部署的 Kubernetes 集群中安装 Cilium.md","filePath":"笔记/🧱 基础设施/🚢 Kubernetes/在 Kubeadm 部署的 Kubernetes 集群中安装 Cilium.md"}'),c={name:"笔记/🧱 基础设施/🚢 Kubernetes/在 Kubeadm 部署的 Kubernetes 集群中安装 Cilium.md"},g=s("h1",{id:"在-kubeadm-部署的-kubernetes-集群中安装-cilium",tabindex:"-1"},[i("在 Kubeadm 部署的 Kubernetes 集群中安装 Cilium "),s("a",{class:"header-anchor",href:"#在-kubeadm-部署的-kubernetes-集群中安装-cilium","aria-label":'Permalink to "在 Kubeadm 部署的 Kubernetes 集群中安装 Cilium"'},"​")],-1),F=s("h3",{id:"文档兼容性",tabindex:"-1"},[i("文档兼容性 "),s("a",{class:"header-anchor",href:"#文档兼容性","aria-label":'Permalink to "文档兼容性"'},"​")],-1),y={tabindex:"0"},C=s("thead",null,[s("tr",null,[s("th",null,"主体"),s("th",null,"版本号"),s("th",null,"文档地址（如果有）")])],-1),u=s("td",null,"Kubernetes",-1),m=s("td",null,"1.28",-1),A=s("td",null,"Cilium",-1),b=s("td",null,"1.14.2",-1),B=s("td",null,"helm",-1),E=s("td",null,"v3.9.0",-1),f=s("h2",{id:"先决条件",tabindex:"-1"},[i("先决条件 "),s("a",{class:"header-anchor",href:"#先决条件","aria-label":'Permalink to "先决条件"'},"​")],-1),_=s("h2",{id:"准备配置文件",tabindex:"-1"},[i("准备配置文件 "),s("a",{class:"header-anchor",href:"#准备配置文件","aria-label":'Permalink to "准备配置文件"'},"​")],-1),v=s("p",null,[i("创建一个名为 "),s("code",null,"cilium-values.yml"),i(" 的配置文件并放到你喜欢的地方，之后我们需要使用 "),s("code",null,"cilium install"),i(" 根据这份配置文件产出最终 "),s("code",null,"helm install"),i(" 需要的配置文件。"),s("sup",{class:"footnote-ref"},[s("a",{href:"#fn1",id:"fnref1"},"[1]")])],-1),D=t(`<div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 默认打开 Hubble 的 Relay 和 UI，这样之后我们就不用再单独执行 cilium hubble enable 来启用了</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">hubble:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  relay:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    enabled:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ui:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    enabled:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ipam:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  # 可以阅读 https://docs.cilium.io/en/stable/network/concepts/ipam/kubernetes/ 了解更多</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  mode:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;kubernetes&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  operator:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 此处的字面量需要和我们的 Kubernetes 在创建的时候指定的 Pod CIDR 相同</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    # 对于先决条件中提及的安装流程，我们在 kubeadm.yaml 中配置了这个相同的字面量，所以到这里我们也使用相同的字面量即可</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    clusterPoolIPv4PodCIDRList:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;10.244.0.0/16&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 如果上面指定了 ipam.operator.clusterPoolIPv4PodCIDRList 那么这里就也得配置成一样的字面量</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ipv4NativeRoutingCIDR:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;10.244.0.0/16&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 如果 tunnel 保持打开（没有安装 kube-proxy 的默认情况下），那么需要开启下面的两个选项</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">enableIPv4Masquerade:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">enableIPv6Masquerade:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span></span></code></pre></div>`,1),x=s("code",null,"ipam.mode",-1),P=s("code",null,"kubernetes",-1),w=t(`<h2 id="产出-helm-所需的配置文件" tabindex="-1">产出 <code>helm</code> 所需的配置文件 <a class="header-anchor" href="#产出-helm-所需的配置文件" aria-label="Permalink to &quot;产出 \`helm\` 所需的配置文件&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --version</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1.14.2</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --values</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-values.yml</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --dry-run-helm-values</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-values-initial.yml</span></span></code></pre></div><p>我们可以使用</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-values-initial.yml</span></span></code></pre></div><p>来预览我们的配置文件：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light one-dark-pro has-highlighted vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kubernetes</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">enableIPv4Masquerade</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">enableIPv6Masquerade</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">hubble</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  relay</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  ui</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">ipam</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  mode</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">kubernetes</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    clusterPoolIPv4PodCIDRList</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">10.244.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">ipv4NativeRoutingCIDR</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">10.244.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 注意确认一下 Kubernetes API Server 的 IP 是否是这个</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">k8sServiceHost</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10.24.0.2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"># 注意确认一下 Kubernetes API Server 的端口是否是这个</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">k8sServicePort</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">6443</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">kubeProxyReplacement</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">strict</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  replicas</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">serviceAccounts</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  cilium</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-operator</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">tunnel</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">vxlan</span></span></code></pre></div><h2 id="使用-helm-安装" tabindex="-1">使用 <code>helm</code> 安装 <a class="header-anchor" href="#使用-helm-安装" aria-label="Permalink to &quot;使用 \`helm\` 安装&quot;">​</a></h2><p>先添加一下 Repo</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> helm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> repo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https://helm.cilium.io/</span></span></code></pre></div><p>然后我们可以使用</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> helm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium/cilium</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --values</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-values-initial.yaml</span></span></code></pre></div><p>来进行安装：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> helm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium/cilium</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --values</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-values-initial.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">NAME:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">LAST</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> DEPLOYED:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Sun</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Oct</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">  8</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 11:56:57</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 2023</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">NAMESPACE:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kube-system</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">STATUS:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> deployed</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">REVISION:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">TEST</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> SUITE:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> None</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">NOTES:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">You</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> have</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> successfully</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> installed</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Hubble</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Relay</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> and</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Hubble</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> UI.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Your</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> release</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> version</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 1.14.2.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">For</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> any</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> further</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> help,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> visit</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https://docs.cilium.io/en/v1.14/gettinghelp</span></span></code></pre></div><p>然后我们过一会儿之后就可以用</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --wait</span></span></code></pre></div><p>来查看 cilium 的状态啦<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --wait</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    /¯¯\\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /¯¯</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\_</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">_/¯¯</span><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">\\ </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   Cilium:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> \\__/¯¯\\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Operator:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">           OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> /¯¯\\__/¯¯\\</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Envoy</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> DaemonSet:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    disabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (using </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">embedded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mode</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> \\__/¯¯\\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Hubble</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Relay:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       OK</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    \\__/</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       ClusterMesh:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">        disabled</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             hubble-relay</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       Desired:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 1,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Ready:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 1/1,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Available:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 1/1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             hubble-ui</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          Desired:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 1,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Ready:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 1/1,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Available:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 1/1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Desired:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 1,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Ready:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 1/1,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Available:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 1/1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">DaemonSet</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">              cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             Desired:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 3,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Ready:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 3/3,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Available:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 3/3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Containers:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">            cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             Running:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-relay</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       Running:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-ui</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          Running:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    Running:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Pods:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          4/6</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> managed</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> by</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Cilium</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Helm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> chart</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> version:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">    1.14.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Image</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> versions</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">         cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">             quay.io/cilium/cilium:v1.14.2@sha256:6263f3a3d5d63b267b538298dbeb5ae87da3efacf09a2c620446c873ba807d35:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-relay</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">       quay.io/cilium/hubble-relay:v1.14.2@sha256:a89030b31f333e8fb1c10d2473250399a1a537c27d022cd8becc1a65d1bef1d6:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-ui</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          quay.io/cilium/hubble-ui:v0.12.0@sha256:1c876cfa1d5e35bc91e1025c9314f922041592a88b03313c22c1f97a5d2ba88f:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       hubble-ui</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          quay.io/cilium/hubble-ui-backend:v0.12.0@sha256:8a79a1aad4fc9c2aa2b3e4379af0af872a89fcec9d99e117188190671c66fc2e:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                       cilium-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">    quay.io/cilium/operator-generic:v1.14.2@sha256:52f70250dea22e506959439a7c4ea31b10fe8375db62f5c27ab746e3a2af866d:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1</span></span></code></pre></div><h2 id="运行连接可用性测试" tabindex="-1">运行连接可用性测试 <a class="header-anchor" href="#运行连接可用性测试" aria-label="Permalink to &quot;运行连接可用性测试&quot;">​</a></h2><p>接下来我们就可以进行测试了，这个测试过程中 Cilium 会利用自己内置的一些用例来对网络策略，网络可用性，连接可达性来进行测试：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> connectivity</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test</span></span></code></pre></div><p>只要看到下面的信息就说明安装好了：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> connectivity</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">✅</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> All</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 42</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> tests</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (295 </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">actions</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) successful, 13 tests skipped, 0 scenarios skipped.</span></span></code></pre></div><h2 id="错误排查" tabindex="-1">错误排查 <a class="header-anchor" href="#错误排查" aria-label="Permalink to &quot;错误排查&quot;">​</a></h2><p>如果测试失败，我们可以用</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pods</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kube-system</span></span></code></pre></div><p>查看 <code>cilium</code> 和 <code>cilium-operator</code> 的运行状况，也可以通过</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubelet</span></span></code></pre></div><p>查看一下 <code>kubelet</code> 的运行状况，然后针对性进行排查。</p><h3 id="因为-cidr-冲突导致的-host-网络异常" tabindex="-1">因为 CIDR 冲突导致的 Host 网络异常 <a class="header-anchor" href="#因为-cidr-冲突导致的-host-网络异常" aria-label="Permalink to &quot;因为 CIDR 冲突导致的 Host 网络异常&quot;">​</a></h3><h4 id="我的集群配置" tabindex="-1">我的集群配置 <a class="header-anchor" href="#我的集群配置" aria-label="Permalink to &quot;我的集群配置&quot;">​</a></h4><p>在我的例子中，我的主路由在 <code>10.0.0.1</code>，我的 Kubernetes 有两个 IP：</p><ol><li>一个是依附于主路由的 DHCP 分配的 <code>10.0.1.24</code></li><li>一个是我专门为构建 Kubernetes 集群所配置静态 IP <code>10.24.0.2</code>，使用的网段 CIDR 是 <code>10.24.0.0/16</code></li></ol><h4 id="表层异常" tabindex="-1">表层异常 <a class="header-anchor" href="#表层异常" aria-label="Permalink to &quot;表层异常&quot;">​</a></h4><p>如果安装 Cilium 之后用</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pods</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kube-system</span></span></code></pre></div><p>去检查 <code>kube-system</code>（Kubernetes 重要组件所处的命名空间）或者别的业务 Pod 所处的命名空间下面的 Pod 的时候，你可能会发现 <code>coredns</code> 的 Pod 或者业务 Pod 无法创建了，他们可能会处于下面几种错误状态中：</p><ul><li><code>ImagePullBackOff</code>：比如 <code>docker.io</code> 或者 <code>quay.io</code> 或者 <code>ghcr.io</code> 的镜像拉不动（前提是你也得确定你的网络是有上层代理帮你加速到国际互联网的）</li><li><code>ErrImagePull</code>：如果上面的 <code>ImagePullBackOff</code> 状态一直无法解决就会这样</li><li><code>CrashLoopBackOff</code>：比如业务 Pod 中会尝试访问外部互联网拉取信息，或者依赖的别的 Pod 出现了异常，无法建立与另一个 Pod 的 TCP 连接或者进行 HTTP 请求；在我的例子中是： <ul><li>一个服务 Pod 连不到 Redis 所在的 Pod 了，因为 Redis Pod 的镜像拉不下来</li><li>一个基于互联网拉取配置的 Pod 连不到互联网了，无法拉取到它希望的配置文件，写了 panic 和 fatal 所以一直在 crash</li></ul></li></ul><h4 id="深层原因" tabindex="-1">深层原因 <a class="header-anchor" href="#深层原因" aria-label="Permalink to &quot;深层原因&quot;">​</a></h4><p>如果我们这个时候检查一下路由表：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> route</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">default</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.0.0.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> eth0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.0.0.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.0.2.208</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium_host</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> src</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.0.2.208</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1450</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.0.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> src</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.0.0.124</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.0.1.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.0.2.208</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium_host</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> src</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.0.2.208</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1450</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.0.2.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.0.2.208</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium_host</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> src</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.0.2.208</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.0.2.208</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium_host</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> link</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">10.24.0.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> eth1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> src</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 10.24.0.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">172.17.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> docker0</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> src</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 172.17.0.1</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> linkdown</span></span></code></pre></div><p>我们可以发现 <code>10.0.0.1</code> 的路由被改变了，如果你的网关路由和我一样是 <code>eth0</code> 上的 <code>10.0.0.1</code> 的话，那说明我们的 CIDR 冲突了，我们得解决一下 Cilium 可分配和应该接管的 CIDR。所以综上所述，出现这个问题最主要的原因可能是 Cilium 和 Kubernetes 节点所属的主路由所使用的 CIDR，或者说和 DNS 和网关路由器所使用的 CIDR 和 IP 冲突了。 但这个问题也许会体现在 <code>ImagePullBackOff</code> 和 <code>ErrImagePull</code> 上，也许不会，但是由于 Cilium 安装之后会尝试接管 Pod，并且重新创建 Pod，所以相比之下 <code>ImagePullBackOff</code> 的错误会更加容易发现，所以如果你也遇到了不知道是不是这样的原因的问题，你也可以试着看看是不是和镜像相关，看看路由表是不是也是有一样的问题。</p><h4 id="为什么会冲突" tabindex="-1">为什么会冲突？ <a class="header-anchor" href="#为什么会冲突" aria-label="Permalink to &quot;为什么会冲突？&quot;">​</a></h4><p>如果你按照 Cilium 官方的指南直接用</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --version</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1.14.2</span></span></code></pre></div>`,44),q=s("code",null,"cilium",-1),I=s("code",null,"10.0.0.0/8",-1),T=s("sup",{class:"footnote-ref"},[s("a",{href:"#fn3",id:"fnref3"},"[3]")],-1),R=s("code",null,"10.0.0.0/8",-1),N=s("code",null,"10.",-1),K=s("code",null,"10.0.0.1",-1),S=s("code",null,"cilium",-1),H=s("code",null,"cilium install",-1),O=s("code",null,"helm install",-1),M=s("code",null,"ipam.operator.clusterPoolIPv4PodCIDRList",-1),V=s("code",null,"ipv4NativeRoutingCIDR",-1),L=t(`<h3 id="pod-网络异常" tabindex="-1">Pod 网络异常 <a class="header-anchor" href="#pod-网络异常" aria-label="Permalink to &quot;Pod 网络异常&quot;">​</a></h3><h4 id="我的集群配置-1" tabindex="-1">我的集群配置 <a class="header-anchor" href="#我的集群配置-1" aria-label="Permalink to &quot;我的集群配置&quot;">​</a></h4><p>在我的例子中，我的主路由在 <code>10.0.0.1</code>，我的 Kubernetes 有两个 IP：</p><ol><li>一个是依附于主路由的 DHCP 分配的 <code>10.0.1.24</code></li><li>一个是我专门为构建 Kubernetes 集群所配置静态 IP <code>10.24.0.2</code>，使用的网段 CIDR 是 <code>10.24.0.0/16</code></li></ol><p>这样的问题有以下几个病症体现。</p><h4 id="hubble-relay-组件报错" tabindex="-1">Hubble Relay 组件报错 <a class="header-anchor" href="#hubble-relay-组件报错" aria-label="Permalink to &quot;Hubble Relay 组件报错&quot;">​</a></h4><p>输出：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> connectivity</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">...</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> # 省略</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Skipping</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> IPCache</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> check</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">🔭</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Enabling</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Hubble</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> telescope...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">⚠️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Unable</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> contact</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Hubble</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Relay,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> disabling</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Hubble</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> telescope</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> and</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flow</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> validation:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> rpc</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> error:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> code</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Unavailable</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> desc</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> connection</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> error:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> desc</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;transport: Error while dialing: dial tcp [::1]:4245: connect: connection refused&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Expose</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Relay</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> locally</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> hubble</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> enable</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">   cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> hubble</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> port-forward</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&amp;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  Cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> version:</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 1.14.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">🏃</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Running</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> tests...</span></span></code></pre></div><p>这说明在进行 Hubble 相关组件的连接可用性测试的时候出现了问题（前提是你确实配置了要开启 Hubble）</p><h4 id="no-policies-用例测试失败" tabindex="-1"><code>[no-policies]</code> 用例测试失败 <a class="header-anchor" href="#no-policies-用例测试失败" aria-label="Permalink to &quot;\`[no-policies]\` 用例测试失败&quot;">​</a></h4><details class="details custom-block"><summary>输出</summary><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">] Test [no-policies]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [-] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Scenario</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [no-policies/pod-to-world]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [.] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [no-policies/pod-to-world/http-to-one.one.one.one-0: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-test/client-78f9dffc84-846qk</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.244.1.121) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> one.one.one.one-http (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">one.one.one.one:80</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ❌</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;curl -w %{local_ip}:%{local_port} -&gt; %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 --retry 3 --retry-all-errors --retry-delay 3 http://one.one.one.one:80&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> failed:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> terminated</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exit</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> code</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  curl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> output:</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-test/client-78f9dffc84-846qk</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> http-to-one.one.one.one-0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> one.one.one.one-http</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> http-to-one.one.one.one-0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [.] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [no-policies/pod-to-world/https-to-one.one.one.one-0: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-test/client-78f9dffc84-846qk</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.244.1.121) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> one.one.one.one-https (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">one.one.one.one:443</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ❌</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;curl -w %{local_ip}:%{local_port} -&gt; %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 --retry 3 --retry-all-errors --retry-delay 3 https://one.one.one.one:443&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> failed:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> terminated</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exit</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> code</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  curl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> output:</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-test/client-78f9dffc84-846qk</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https-to-one.one.one.one-0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> one.one.one.one-https</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https-to-one.one.one.one-0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [.] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [no-policies/pod-to-world/https-to-one.one.one.one-index-0: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-test/client-78f9dffc84-846qk</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.244.1.121) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> one.one.one.one-https-index (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">one.one.one.one:443</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ❌</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;curl -w %{local_ip}:%{local_port} -&gt; %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 --retry 3 --retry-all-errors --retry-delay 3 https://one.one.one.one:443/index.html&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> failed:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> terminated</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exit</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> code</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  curl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> output:</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-test/client-78f9dffc84-846qk</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https-to-one.one.one.one-index-0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> one.one.one.one-https-index</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https-to-one.one.one.one-index-0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [.] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [no-policies/pod-to-world/http-to-one.one.one.one-1: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-test/client2-59b578d4bb-hv5b2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.244.1.252) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> one.one.one.one-http (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">one.one.one.one:80</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ❌</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;curl -w %{local_ip}:%{local_port} -&gt; %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 --retry 3 --retry-all-errors --retry-delay 3 http://one.one.one.one:80&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> failed:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> terminated</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exit</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> code</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  curl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> output:</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-test/client2-59b578d4bb-hv5b2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> http-to-one.one.one.one-1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> one.one.one.one-http</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> http-to-one.one.one.one-1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [.] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [no-policies/pod-to-world/https-to-one.one.one.one-1: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-test/client2-59b578d4bb-hv5b2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.244.1.252) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> one.one.one.one-https (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">one.one.one.one:443</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ❌</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;curl -w %{local_ip}:%{local_port} -&gt; %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 --retry 3 --retry-all-errors --retry-delay 3 https://one.one.one.one:443&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> failed:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> terminated</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exit</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> code</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  curl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> output:</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-test/client2-59b578d4bb-hv5b2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https-to-one.one.one.one-1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> one.one.one.one-https</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https-to-one.one.one.one-1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [.] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [no-policies/pod-to-world/https-to-one.one.one.one-index-1: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-test/client2-59b578d4bb-hv5b2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.244.1.252) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> one.one.one.one-https-index (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">one.one.one.one:443</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ❌</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;curl -w %{local_ip}:%{local_port} -&gt; %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 --retry 3 --retry-all-errors --retry-delay 3 https://one.one.one.one:443/index.html&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> failed:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> terminated</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exit</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> code</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  curl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> output:</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-test/client2-59b578d4bb-hv5b2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https-to-one.one.one.one-index-1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> one.one.one.one-https-index</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> https-to-one.one.one.one-index-1</span></span></code></pre></div></details><h4 id="to-entities-world-用例失败" tabindex="-1"><code>[to-entities-world]</code> 用例失败 <a class="header-anchor" href="#to-entities-world-用例失败" aria-label="Permalink to &quot;\`[to-entities-world]\` 用例失败&quot;">​</a></h4><details class="details custom-block"><summary>输出</summary><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span>[=] Test [to-entities-world]</span></span>
<span class="line"><span>.</span></span>
<span class="line"><span>  ℹ️  📜 Applying CiliumNetworkPolicy &#39;client-egress-to-entities-world&#39; to namespace &#39;cilium-test&#39;..</span></span>
<span class="line"><span>  [-] Scenario [to-entities-world/pod-to-world]</span></span>
<span class="line"><span>  [.] Action [to-entities-world/pod-to-world/http-to-one.one.one.one-0: cilium-test/client-78f9dffc84-846qk (10.244.1.121) -&gt; one.one.one.one-http (one.one.one.one:80)]</span></span>
<span class="line"><span>  ❌ command &quot;curl -w %{local_ip}:%{local_port} -&gt; %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 --retry 3 --retry-all-errors --retry-delay 3 http://one.one.one.one:80&quot; failed: command terminated with exit code 28</span></span>
<span class="line"><span>  ℹ️  curl output:</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>  📄 No flows recorded for peer cilium-test/client-78f9dffc84-846qk during action http-to-one.one.one.one-0</span></span>
<span class="line"><span>  📄 No flows recorded for peer one.one.one.one-http during action http-to-one.one.one.one-0</span></span>
<span class="line"><span>  [.] Action [to-entities-world/pod-to-world/https-to-one.one.one.one-0: cilium-test/client-78f9dffc84-846qk (10.244.1.121) -&gt; one.one.one.one-https (one.one.one.one:443)]</span></span>
<span class="line"><span>  [.] Action [to-entities-world/pod-to-world/https-to-one.one.one.one-index-0: cilium-test/client-78f9dffc84-846qk (10.244.1.121) -&gt; one.one.one.one-https-index (one.one.one.one:443)]</span></span>
<span class="line"><span>  [.] Action [to-entities-world/pod-to-world/http-to-one.one.one.one-1: cilium-test/client2-59b578d4bb-hv5b2 (10.244.1.252) -&gt; one.one.one.one-http (one.one.one.one:80)]</span></span>
<span class="line"><span>  ❌ command &quot;curl -w %{local_ip}:%{local_port} -&gt; %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 --retry 3 --retry-all-errors --retry-delay 3 http://one.one.one.one:80&quot; failed: command terminated with exit code 28</span></span>
<span class="line"><span>  ℹ️  curl output:</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>  📄 No flows recorded for peer cilium-test/client2-59b578d4bb-hv5b2 during action http-to-one.one.one.one-1</span></span>
<span class="line"><span>  📄 No flows recorded for peer one.one.one.one-http during action http-to-one.one.one.one-1</span></span>
<span class="line"><span>  [.] Action [to-entities-world/pod-to-world/https-to-one.one.one.one-1: cilium-test/client2-59b578d4bb-hv5b2 (10.244.1.252) -&gt; one.one.one.one-https (one.one.one.one:443)]</span></span>
<span class="line"><span>  [.] Action [to-entities-world/pod-to-world/https-to-one.one.one.one-index-1: cilium-test/client2-59b578d4bb-hv5b2 (10.244.1.252) -&gt; one.one.one.one-https-index (one.one.one.one:443)]</span></span>
<span class="line"><span>  ℹ️  📜 Deleting CiliumNetworkPolicy &#39;client-egress-to-entities-world&#39; from namespace &#39;cilium-test&#39;..</span></span></code></pre></div></details><h4 id="to-cidr-external-用例失败" tabindex="-1"><code>[to-cidr-external]</code> 用例失败 <a class="header-anchor" href="#to-cidr-external-用例失败" aria-label="Permalink to &quot;\`[to-cidr-external]\` 用例失败&quot;">​</a></h4><details class="details custom-block"><summary>输出</summary><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">] Test [to-cidr-external]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  📜</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Applying</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> CiliumNetworkPolicy</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;client-egress-to-cidr&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;cilium-test&#39;..</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [-] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Scenario</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [to-cidr-external/pod-to-cidr]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [.] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [to-cidr-external/pod-to-cidr/external-1111-0: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-test/client-78f9dffc84-846qk</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.244.1.121) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> external-1111 (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">1.1.1.1:443</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ❌</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;curl -w %{local_ip}:%{local_port} -&gt; %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 --retry 3 --retry-all-errors --retry-delay 3 https://1.1.1.1:443&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> failed:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> terminated</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exit</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> code</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  curl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> output:</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-test/client-78f9dffc84-846qk</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> external-1111-0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> external-1111</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> external-1111-0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [.] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [to-cidr-external/pod-to-cidr/external-1111-1: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-test/client2-59b578d4bb-hv5b2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.244.1.252) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> external-1111 (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">1.1.1.1:443</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ❌</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;curl -w %{local_ip}:%{local_port} -&gt; %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 --retry 3 --retry-all-errors --retry-delay 3 https://1.1.1.1:443&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> failed:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> terminated</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exit</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> code</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  curl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> output:</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-test/client2-59b578d4bb-hv5b2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> external-1111-1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> external-1111</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> external-1111-1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [.] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [to-cidr-external/pod-to-cidr/external-1001-0: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-test/client-78f9dffc84-846qk</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.244.1.121) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> external-1001 (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">1.0.0.1:443</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [.] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [to-cidr-external/pod-to-cidr/external-1001-1: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-test/client2-59b578d4bb-hv5b2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.244.1.252) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> external-1001 (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">1.0.0.1:443</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  📜</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Deleting</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> CiliumNetworkPolicy</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;client-egress-to-cidr&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;cilium-test&#39;..</span></span></code></pre></div></details><h4 id="to-cidr-external-knp-用例失败" tabindex="-1"><code>[to-cidr-external-knp]</code> 用例失败 <a class="header-anchor" href="#to-cidr-external-knp-用例失败" aria-label="Permalink to &quot;\`[to-cidr-external-knp]\` 用例失败&quot;">​</a></h4><details class="details custom-block"><summary>输出</summary><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">] Test [to-cidr-external-knp]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#56B6C2;">.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  📜</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> Applying</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> KubernetesNetworkPolicy</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;client-egress-to-cidr&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &#39;cilium-test&#39;..</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [-] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Scenario</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [to-cidr-external-knp/pod-to-cidr]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [.] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [to-cidr-external-knp/pod-to-cidr/external-1111-0: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-test/client-78f9dffc84-846qk</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.244.1.121) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> external-1111 (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">1.1.1.1:443</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ❌</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;curl -w %{local_ip}:%{local_port} -&gt; %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 --retry 3 --retry-all-errors --retry-delay 3 https://1.1.1.1:443&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> failed:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> terminated</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exit</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> code</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  curl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> output:</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-test/client-78f9dffc84-846qk</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> external-1111-0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> external-1111</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> external-1111-0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">  [.] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> [to-cidr-external-knp/pod-to-cidr/external-1111-1: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">cilium-test/client2-59b578d4bb-hv5b2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (10.244.1.252) -</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> external-1111 (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">1.1.1.1:443</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ❌</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;curl -w %{local_ip}:%{local_port} -&gt; %{remote_ip}:%{remote_port} = %{response_code} --silent --fail --show-error --output /dev/null --connect-timeout 2 --max-time 10 --retry 3 --retry-all-errors --retry-delay 3 https://1.1.1.1:443&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> failed:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> terminated</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exit</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> code</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 28</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  ℹ️</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  curl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> output:</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-test/client2-59b578d4bb-hv5b2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> external-1111-1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  📄</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> flows</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> recorded</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> external-1111</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> during</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> external-1111-1</span></span></code></pre></div></details><h4 id="在-pod-中使用-curl-直接访问-baidu-com-和-1-1-1-1-也都失败" tabindex="-1">在 Pod 中使用 <code>curl</code> 直接访问 <code>baidu.com</code> 和 <code>1.1.1.1</code> 也都失败 <a class="header-anchor" href="#在-pod-中使用-curl-直接访问-baidu-com-和-1-1-1-1-也都失败" aria-label="Permalink to &quot;在 Pod 中使用 \`curl\` 直接访问 \`baidu.com\` 和 \`1.1.1.1\` 也都失败&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -it</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --rm</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> test</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --image=curlimages/curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --restart=Never</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> /bin/sh</span></span></code></pre></div><p>如果使用上面的命令进入到一个用于测试网络连接的 <code>curl</code> 镜像中请求 <code>baidu.com</code> 和 <code>1.1.1.1</code>，你也可以发现我们的请求要么被挂起然后超时，要么直接返回说无法解析，或者没有路由。</p><h4 id="在-pod-中使用-cilium-health-status-是正常的" tabindex="-1">在 Pod 中使用 <code>cilium-health status</code> 是正常的 <a class="header-anchor" href="#在-pod-中使用-cilium-health-status-是正常的" aria-label="Permalink to &quot;在 Pod 中使用 \`cilium-health status\` 是正常的&quot;">​</a></h4><p>Cilium 提供了 <code>cilium-health status</code> 命令可以用于测试集群内的通信，我们可以先用</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> pods</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kube-system</span></span></code></pre></div><p>找到 Cilium 的容器，然后执行：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kube-system</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -ti</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">Pod</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> I</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">D</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-health</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> status</span></span></code></pre></div><p>效果：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kube-system</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> -ti</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-8l4r7</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-health</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Defaulted</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> container</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &quot;cilium-agent&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> out</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> of:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> cilium-agent,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> config</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (init), mount-cgroup (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">init</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">), apply-sysctl-overwrites (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">init</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">), mount-bpf-fs (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">init</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">), clean-cilium-state (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">init</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">), install-cni-binaries (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">init</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Probe</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> time:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   2023-10-06T11:03:33Z</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Nodes:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  cluster.local/node3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (localhost):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Host</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> connectivity</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 10.24.0.5:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      ICMP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> stack:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   OK,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> RTT=682.798µs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      HTTP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> agent:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   OK,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> RTT=372.599µs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Endpoint</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> connectivity</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 10.233.66.239:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      ICMP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> stack:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   OK,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> RTT=545.998µs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      HTTP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> agent:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   OK,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> RTT=652.498µs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  cluster.local/node1:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Host</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> connectivity</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 10.24.0.2:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      ICMP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> stack:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   OK,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> RTT=890.197µs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      HTTP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> agent:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   OK,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> RTT=921.697µs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Endpoint</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> connectivity</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 10.233.64.91:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      ICMP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> stack:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   OK,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> RTT=927.897µs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      HTTP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> agent:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   OK,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> RTT=879.597µs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">  cluster.local/node2:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Host</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> connectivity</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 10.24.0.4:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      ICMP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> stack:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   OK,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> RTT=896.297µs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      HTTP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> agent:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   OK,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> RTT=798.897µs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Endpoint</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> connectivity</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> 10.233.65.82:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      ICMP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> stack:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   OK,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> RTT=880.497µs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">      HTTP</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> agent:</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   OK,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> RTT=1.102096ms</span></span></code></pre></div><h4 id="是什么造成的" tabindex="-1">是什么造成的？ <a class="header-anchor" href="#是什么造成的" aria-label="Permalink to &quot;是什么造成的？&quot;">​</a></h4><p>上面的几个问题都体现在外部网络的访问，无论是基于 CIDR 的访问，还是域名访问，无论是有规则还是无规则都无法通过 <code>curl</code> 去请求成功，如果我们仔细观察这几个测试用例的话我们能发现测试目标都是 <code>one.one.one.one</code> 和 <code>1.1.1.1</code> ，是 Cloudflare 的 DNS，那这里可能会有几种情况：</p>`,29),$=s("li",null,[i("如果是在中国大陆部署的机器，是不是因为 "),s("code",null,"1.1.1.1"),i(" 被墙了，如果是的话，可以检查一下代理是否配置正确，节点是否选择正确")],-1),U=t("<li>如果宿主机可以访问 <ol><li><code>kubelet</code> 正常吗？<code>cilium</code> 正常吗？如果 <code>kubelet</code> 报错说 <code>cni plugin not initialized</code>，也许是 <code>cilium</code> 的问题，可以先用 <code>sudo kubectl get pods -n kube-system</code> 寻找一下 <code>cilium</code> 的 Pod，然后通过 <code>sudo kubectl logs -f &lt;Cilium Pod 的 ID&gt;</code> 来排查</li><li>如果都正常的话，你可能遭遇了我也遭遇的问题。</li></ol></li>",1),G=t(`<p>我遭遇相似问题的时候使用了下面的配置去安装的 Cilium：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light one-dark-pro has-highlighted vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">hubble</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  relay</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  ui</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">ipam</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  mode</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;kubernetes&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">  operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">    clusterPoolIPv4PodCIDRList</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;10.244.0.0/16&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">ipv4NativeRoutingCIDR</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;10.244.0.0/16&#39;</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">enableIPv4Masquerade</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">false</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">enableIPv6Masquerade</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">false</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">autoDirectNodeRoutes</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span></span>
<span class="line highlighted"><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;">tunnel</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">disabled</span></span></code></pre></div><p>可以看到高亮的这几个选项和我在上面提到的安装的选项是不一样的。</p><ol><li>我提及到说我的 Kubernetes 集群中的节点都在同一个 <code>10.24.0.0/16</code> 子网，我以为这符合文档中的 L2 层网络，毕竟这个子网是直接由 Hyper-V 的虚拟网卡提供的，所以我打开了 <code>autoDirectNodeRoutes</code>，然后关掉 <code>tunnel</code>，也没有安装 <code>kube-proxy</code></li><li>又因为 <code>enableIPv4Masquerade</code> 和 <code>enableIPv6Masquerade</code> 和 <code>tunnel</code> 是相关的，因为 <code>tunnel</code> 打开之后也需要打开这两个选项，所以我错误地理解为关掉 <code>tunnel</code> 的时候也需要关闭这两个选项，所以也都配置为了 <code>false</code></li></ol><p>但是不知道为什么，这样的配置会导致 Pod 的网络出现问题，包括 Pod 到 Pod 的网络也会故障，我目前还不得而知原因。</p><h4 id="如何解决" tabindex="-1">如何解决？ <a class="header-anchor" href="#如何解决" aria-label="Permalink to &quot;如何解决？&quot;">​</a></h4><p>解决这个问题的关键就在于：</p><ol><li>我们如果没有安装 <code>kube-proxy</code>，我们需要激活 <code>tunnel</code>，你可以保持 <code>tunnel</code> 的配置为默认值（比如你可以删掉然后让 <code>cilium install</code> 帮你判断）</li><li>因为我们激活了 <code>tunnel</code>，<code>autoDirectNodeRoutes</code> 和 <code>tunnel</code> 是互斥的，我们需要把 <code>autoDirectNodeRoutes</code> 关掉</li><li>因为我们激活了 <code>tunnel</code>，<code>enableIPv4Masquerade</code> 和 <code>enableIPv6Masquerade</code> 都要开启，所以我们都配置为 <code>true</code></li></ol><h4 id="延伸阅读" tabindex="-1">延伸阅读 <a class="header-anchor" href="#延伸阅读" aria-label="Permalink to &quot;延伸阅读&quot;">​</a></h4>`,9),Y=s("hr",{class:"footnotes-sep"},null,-1),j={class:"footnotes"},z={class:"footnotes-list"},J={id:"fn1",class:"footnote-item"},Z=s("a",{href:"#fnref1",class:"footnote-backref"},"↩︎",-1),Q={id:"fn2",class:"footnote-item"},W=s("code",null,"helm",-1),X=s("code",null,"helm",-1),ss=s("code",null,"cilium",-1),is=s("a",{href:"#fnref2",class:"footnote-backref"},"↩︎",-1),as={id:"fn3",class:"footnote-item"},ns=s("code",null,"10.0.0.0/8",-1),ls=s("code",null,"10",-1),ts=s("code",null,"10",-1),es=s("a",{href:"#fnref3",class:"footnote-backref"},"↩︎",-1);function hs(ks,ps,rs,ds,os,cs){const h=e("NolebasePageProperties"),n=e("VPNolebaseInlineLinkPreview"),k=e("NolebaseGitContributors"),p=e("NolebaseGitChangelog");return o(),d("div",null,[g,a(h),F,s("table",y,[C,s("tbody",null,[s("tr",null,[u,m,s("td",null,[a(n,{href:"https://v1-28.docs.kubernetes.io/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("https://v1-28.docs.kubernetes.io/")]),_:1})])]),s("tr",null,[A,b,s("td",null,[a(n,{href:"https://docs.cilium.io/en/v1.14/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("https://docs.cilium.io/en/v1.14/")]),_:1})])]),s("tr",null,[B,E,s("td",null,[a(n,{href:"https://helm.sh/docs/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("https://helm.sh/docs/")]),_:1})])])])]),f,s("ul",null,[s("li",null,[a(n,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/为安装 CNI 使用 Kubeadm 准备一个 Kubernetes 集群.html"},{default:l(()=>[i("为安装 CNI 使用 Kubeadm 准备一个 Kubernetes 集群")]),_:1})])]),_,v,s("p",null,[i("对于一个根据"),a(n,{href:"#先决条件"},{default:l(()=>[i("先决条件")]),_:1}),i("中的要求，我们可以撰写如下的文件内容：")]),D,s("p",null,[i("对于 "),x,i(" 为 "),P,i("，你可以在 "),a(n,{href:"https://docs.cilium.io/en/stable/network/concepts/ipam/cluster-pool/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Cluster Scope (Default) — Cilium 1.14.2 documentation")]),_:1}),i(" 和 "),a(n,{href:"https://docs.cilium.io/en/stable/network/concepts/ipam/kubernetes/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Kubernetes Host Scope — Cilium 1.14.2 documentation")]),_:1}),i(" 了解更多。")]),w,s("p",null,[i("这样的命令在 Kubernetes 集群中安装，那 "),q,i(" 是默认使用的 "),a(n,{href:"https://docs.cilium.io/en/stable/network/concepts/ipam/cluster-pool/#ipam-crd-cluster-pool",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Cluster Scope (Default)")]),_:1}),i(" 作为 IPAM 的模式来运行，而 "),a(n,{href:"https://docs.cilium.io/en/stable/network/concepts/ipam/cluster-pool/#ipam-crd-cluster-pool",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Cluster Scope (Default)")]),_:1}),i(" 好巧不巧使用的默认的 CIDR 是 "),I,T,i("，如果你学过 CIDR（没有学过也不要紧，可以看看"),a(n,{href:"/笔记/🛠️ 开发/🕸 网络/IP 后面的斜杠是什么？.html"},{default:l(()=>[i("IP 后面的斜杠是什么？")]),_:1}),i("），你可以看出来 "),R,i(" 意味着 "),N,i(" 后面的数字都是可以被分配的，这也就意味着 "),K,i(" 也是 "),S,i(" 接管的流量的一部分了，所以会出现这样的问题。")]),s("p",null,[i("正确的做法是我们在安装的时候给参数或者在给 "),H,i(" 使用的或者 "),O,i(" 使用的配置文件中配置一下 "),M,i(" 和 "),V,i(" 这两个字段，配置的字面量与 Kubernetes 集群的配置相同即可。如果你想要删除 Cilium 重新部署，可以参考一下"),a(n,{href:"/笔记/🧱 基础设施/🚢 Kubernetes/完全卸载使用 Helm 安装的 Cilium.html"},{default:l(()=>[i("完全卸载使用 Helm 安装的 Cilium")]),_:1}),i(" 这篇文档的指引。")]),L,s("ol",null,[s("li",null,[i("如果说我们宿主机也无法访问 "),s("ol",null,[$,s("li",null,[i("如果说代理正确的话，那可能你可以参考一下 "),a(n,{href:"#因为-cidr-冲突导致的-host-网络异常"},{default:l(()=>[i("因为 CIDR 冲突导致的 Host 网络异常")]),_:1}),i("部分是否匹配你正在遭遇的故障，也许是因为 CIDR 的冲突导致 DNS 或者路由挂了")])])]),U]),G,s("ul",null,[s("li",null,[a(n,{href:"https://github.com/cilium/cilium/issues/16235",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Cannot reach external endpoint with service ip when the external endpoint is one of k8s node · Issue #16235 · cilium/cilium")]),_:1})]),s("li",null,[a(n,{href:"https://stackoverflow.com/questions/76432743/cant-access-the-external-network-from-pod-nginx-pod",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("kubernetes - Can’t access the external network from pod (nginx-pod) - Stack Overflow")]),_:1})]),s("li",null,[a(n,{href:"https://serverfault.com/questions/1103034/kubernetes-nodes-are-not-reachable-and-cannot-reach-local-network-after-installi",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("linux - Kubernetes Nodes are not reachable and cannot reach local network after installing cilium - Server Fault")]),_:1})]),s("li",null,[a(n,{href:"https://github.com/cilium/cilium/issues/20085",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Pod cannot access external network · Issue #20085 · cilium/cilium")]),_:1})]),s("li",null,[a(n,{href:"https://github.com/cilium/cilium/issues/22162",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("CI: ConformanceAKS: curl succeeded while it should have failed due to incorrect exit code · Issue #22162 · cilium/cilium")]),_:1})]),s("li",null,[a(n,{href:"https://github.com/cilium/cilium-cli/issues/673",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("cilium connectivity test failures · Issue #673 · cilium/cilium-cli")]),_:1})]),s("li",null,[a(n,{href:"https://github.com/kubernetes-sigs/kubespray/issues/8546",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Cilium deployment fails to pass conn test and sonobuoy · Issue #8546 · kubernetes-sigs/kubespray")]),_:1})])]),a(k),a(p),Y,s("section",j,[s("ol",z,[s("li",J,[s("p",null,[i("虽然 "),a(n,{href:"https://docs.cilium.io/en/stable/installation/k8s-install-migration/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Migrating a cluster to Cilium")]),_:1}),i(" 是专门为迁移到 Cilium 准备的文档，如果我们是全新的安装，那这里面有的步骤是不需要遵循的，但是我们可以借鉴一下部分的操作。 "),Z])]),s("li",Q,[s("p",null,[i("在 "),a(n,{href:"https://docs.cilium.io/en/stable/installation/k8s-install-helm/",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Installation using Helm")]),_:1}),i(" 中讲解了如何使用 "),W,i(" 进行安装，"),X,i(" 安装和直接用 "),ss,i(" 安装其实底层上而言是一样的，但是配置的过程不同，也可以阅读一下这篇文档来了解区别。 "),is])]),s("li",as,[s("p",null,[i("对于默认的 "),a(n,{href:"https://docs.cilium.io/en/stable/network/concepts/ipam/cluster-pool/#check-for-conflicting-node-cidrs",target:"_blank",rel:"noreferrer"},{default:l(()=>[i("Cluster Scope (Default)")]),_:1}),i(" 模式而言，Cilium 默认使用 "),ns,i(" 作为 Pod 的 CIDR，不得不说是真的太野了，这样的 CIDR 返回将会覆盖整个 "),ls,i(" IP 段，很多内网基础设施都是选择的 "),ts,i(" 段，如果直接用默认配置肯定会出大问题。 "),es])])])])])}const ys=r(c,[["render",hs]]);export{Fs as __pageData,ys as default};
