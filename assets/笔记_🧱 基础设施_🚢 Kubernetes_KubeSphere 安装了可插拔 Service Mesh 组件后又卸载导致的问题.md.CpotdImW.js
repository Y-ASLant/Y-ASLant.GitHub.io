import{_ as p,c,I as s,j as e,w as i,a as t,au as d,D as o,o as h}from"./chunks/framework.RMxno62p.js";const w=JSON.parse('{"title":"KubeSphere 安装了可插拔 Service Mesh 组件后又卸载导致的问题","description":"","frontmatter":{"tags":["开发/云原生/Kubernetes","开发/云原生/Kubernetes/K8s","运维/云原生/Kubernetes","运维/云原生/Kubernetes/K8s","命令行/kubectl","运维/云原生/Kubernetes/KubeSphere","开源/软件/KubeSphere","开发/云原生/网络/服务网格/Service-Mesh","开发/云原生/网络/服务网格"]},"headers":[],"relativePath":"笔记/🧱 基础设施/🚢 Kubernetes/KubeSphere 安装了可插拔 Service Mesh 组件后又卸载导致的问题.md","filePath":"笔记/🧱 基础设施/🚢 Kubernetes/KubeSphere 安装了可插拔 Service Mesh 组件后又卸载导致的问题.md"}'),u={name:"笔记/🧱 基础设施/🚢 Kubernetes/KubeSphere 安装了可插拔 Service Mesh 组件后又卸载导致的问题.md"},k=e("h1",{id:"kubesphere-安装了可插拔-service-mesh-组件后又卸载导致的问题",tabindex:"-1"},[t("KubeSphere 安装了可插拔 Service Mesh 组件后又卸载导致的问题 "),e("a",{class:"header-anchor",href:"#kubesphere-安装了可插拔-service-mesh-组件后又卸载导致的问题","aria-label":'Permalink to "KubeSphere 安装了可插拔 Service Mesh 组件后又卸载导致的问题"'},"​")],-1),b=e("h3",{id:"文档兼容性",tabindex:"-1"},[t("文档兼容性 "),e("a",{class:"header-anchor",href:"#文档兼容性","aria-label":'Permalink to "文档兼容性"'},"​")],-1),g={tabindex:"0"},q=e("thead",null,[e("tr",null,[e("th",null,"主体"),e("th",null,"版本号"),e("th",null,"文档地址（如果有）")])],-1),v=e("td",null,"KubeSphere",-1),_=e("td",null,"v3.3.0",-1),m=e("td",null,"Kubernetes",-1),y=e("td",null,"v1.22.0",-1),C=d(`<h2 id="说明" tabindex="-1">说明 <a class="header-anchor" href="#说明" aria-label="Permalink to &quot;说明&quot;">​</a></h2><p>我在尝试手动通过 <code>kubectl</code> 命令为 k8s 集群上的 deployment 更新其部署的镜像，以方便集成到 Circle CI 并打通整个 CI/CD 流程来替换我们先前的 Docker Swarm 相关的命令操作。 但令人惊奇的是，我使用 <code>kubectl rollout restart</code> 和 <code>kubectl set image</code> 这两个命令都无法为先前创建的 deployment 进行更新，甚至是 <code>kubectl apply</code> 也失效了。</p><p>由于这些命令能够正确返回，并没有报错，所以起初我没有扩大范围去排查和 debug，我以为只是我没有好好阅读对于 <code>kubectl rollout restart</code> 这个命令的描述文档而导致的，这致使我一直在尝试查找资料和阅读 Issue、文档等内容来加深理解和学习具体的工作方式和需要注意的内容，但直到我发现 KubeSphere 提供的 WebUI，以及 <code>kubectl set image</code> 和 <code>kubectl apply</code> 这两个更强制的命令都失效之后才恍然大悟：也许是集群上出现了什么问题。</p><h2 id="排查过程" tabindex="-1">排查过程 <a class="header-anchor" href="#排查过程" aria-label="Permalink to &quot;排查过程&quot;">​</a></h2><p>我看了看每一个 KubeSphere 核心组件的状态，它们都是正常的。 也或许日志里会有什么线索？于是我看了看提供用于集群管理的 API 接口服务 <code>ks-apiserver</code>，发现有这么几行错误：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span>E1101 23:23:34.180786 1 utils.go:76] /workspace/pkg/kapis/resources/v1alpha3/handler.go:289 GET https://hub.example.com/v2/namespace/repo/manifests/latest: unexpected status code 401 Unauthorized: &lt;html&gt;</span></span>
<span class="line"><span>&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;</span></span>
<span class="line"><span>&lt;body&gt;</span></span>
<span class="line"><span>&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;</span></span>
<span class="line"><span>&lt;hr&gt;&lt;center&gt;nginx/1.18.0&lt;/center&gt;</span></span>
<span class="line"><span>&lt;/body&gt;</span></span>
<span class="line"><span>&lt;/html&gt;</span></span></code></pre></div><p>这看起来是在访问私有 Docker Registry 的时候出现的问题，于是我去 KubeSphere 的 WebUI 上尝试编辑 deployment 的容器镜像来尝试让 KubeSphere 拉取到镜像的信息，发现在 WebUI 上编辑容器镜像的时候是能够正常拉取镜像和镜像 manifest 信息的，那说明应该不是这个问题，至少不会报 <code>401 Authorization Required</code> 的错误。 那会是哪里出了问题呢？也许是 Kubernetes 的核心服务出了问题？我去检查了 <code>kube-controller-manager-svc</code> （用于内嵌随 Kubernetes 一起发布的核心控制回路）的容器日志，然后发现了这么些错误和信息：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span>I1101 23:26:30.165776 1 event.go:291] &quot;Event occurred&quot; object=&quot;namespace/service-v1-688965cd66&quot; kind=&quot;ReplicaSet&quot; apiVersion=&quot;apps/v1&quot; type=&quot;Warning&quot; reason=&quot;FailedCreate&quot; message=&quot;Error creating: Internal error occurred: failed calling webhook \\&quot;rev.object.sidecar-injector.istio.io\\&quot;: failed to call webhook: Post \\&quot;https://istiod-1-11-2.istio-system.svc:443/inject?timeout=10s\\&quot;: service \\&quot;istiod-1-11-2\\&quot; not found&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>E1101 23:26:30.329218 1 replica_set.go:536] sync &quot;namespace/service-v1-688965cd66&quot; failed with Internal error occurred: failed calling webhook &quot;rev.object.sidecar-injector.istio.io&quot;: failed to call webhook: Post &quot;https://istiod-1-11-2.istio-system.svc:443/inject?timeout=10s&quot;: service &quot;istiod-1-11-2&quot; not found</span></span>
<span class="line"><span></span></span>
<span class="line"><span>I1101 23:26:30.329252 1 event.go:291] &quot;Event occurred&quot; object=&quot;namespace/service-v1-688965cd66&quot; kind=&quot;ReplicaSet&quot; apiVersion=&quot;apps/v1&quot; type=&quot;Warning&quot; reason=&quot;FailedCreate&quot; message=&quot;Error creating: Internal error occurred: failed calling webhook \\&quot;rev.object.sidecar-injector.istio.io\\&quot;: failed to call webhook: Post \\&quot;https://istiod-1-11-2.istio-system.svc:443/inject?timeout=10s\\&quot;: service \\&quot;istiod-1-11-2\\&quot; not found&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>E1101 23:26:30.651984 1 replica_set.go:536] sync &quot;namespace/service-v1-688965cd66&quot; failed with Internal error occurred: failed calling webhook &quot;rev.object.sidecar-injector.istio.io&quot;: failed to call webhook: Post &quot;https://istiod-1-11-2.istio-system.svc:443/inject?timeout=10s&quot;: service &quot;istiod-1-11-2&quot; not found</span></span>
<span class="line"><span></span></span>
<span class="line"><span>I1101 23:26:30.652267 1 event.go:291] &quot;Event occurred&quot; object=&quot;namespace/service-v1-688965cd66&quot; kind=&quot;ReplicaSet&quot; apiVersion=&quot;apps/v1&quot; type=&quot;Warning&quot; reason=&quot;FailedCreate&quot; message=&quot;Error creating: Internal error occurred: failed calling webhook \\&quot;rev.object.sidecar-injector.istio.io\\&quot;: failed to call webhook: Post \\&quot;https://istiod-1-11-2.istio-system.svc:443/inject?timeout=10s\\&quot;: service \\&quot;istiod-1-11-2\\&quot; not found&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>E1101 23:26:31.296499 1 replica_set.go:536] sync &quot;namespace/service-v1-688965cd66&quot; failed with Internal error occurred: failed calling webhook &quot;rev.object.sidecar-injector.istio.io&quot;: failed to call webhook: Post &quot;https://istiod-1-11-2.istio-system.svc:443/inject?timeout=10s&quot;: service &quot;istiod-1-11-2&quot; not found</span></span>
<span class="line"><span></span></span>
<span class="line"><span>I1101 23:26:31.296517 1 event.go:291] &quot;Event occurred&quot; object=&quot;namespace/service-v1-688965cd66&quot; kind=&quot;ReplicaSet&quot; apiVersion=&quot;apps/v1&quot; type=&quot;Warning&quot; reason=&quot;FailedCreate&quot; message=&quot;Error creating: Internal error occurred: failed calling webhook \\&quot;rev.object.sidecar-injector.istio.io\\&quot;: failed to call webhook: Post \\&quot;https://istiod-1-11-2.istio-system.svc:443/inject?timeout=10s\\&quot;: service \\&quot;istiod-1-11-2\\&quot; not found&quot;</span></span></code></pre></div><p>看起来大概是找到了问题了，与我们需要配置的 deployment 名字相关，也确实是在执行 <code>ReplicaSet</code> 操作，但是这个 <code>failed calling webhook &quot;rev.object.sidecar-injector.istio.io&quot;</code> 是什么错误呢？我想起来我之前在尝试配置 KubeSphere 的可插拔组件 Service Mesh 的时候有提到 Service Mesh 是由 Istio 提供的，也许是在我后来卸载 Service Mesh 可插拔组件的时候没有完全清理完资源导致的？ 我尝试搜索了一下这个错误，发现挺多人遇到的。但解决起来也非常简单就是了。</p><h2 id="解决问题" tabindex="-1">解决问题 <a class="header-anchor" href="#解决问题" aria-label="Permalink to &quot;解决问题&quot;">​</a></h2><p>我们需要检查两个资源，分别是 <code>ValidatingWebhookConfiguration</code> 和 <code>MutatingWebhookConfiguration</code>，使用下列命令就能看到：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ValidatingWebhookConfiguration</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                                          WEBHOOKS</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">istio-validator-1-11-2-istio-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">           2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          8d</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> MutatingWebhookConfiguration</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">                            WEBHOOKS</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">istio-sidecar-injector-1-11-2</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">   2</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">          8d</span></span></code></pre></div><p>接下来只需要运行下面的两个命令就能清理掉错误的资源了：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> delete</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> ValidatingWebhookConfiguration</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> istio-validator-1-11-2-istio-system</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> delete</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> MutatingWebhookConfiguration</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> istio-sidecar-injector-1-11-2</span></span></code></pre></div><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to &quot;参考资料&quot;">​</a></h2>`,17);function f(F,S,K,j,E,P){const n=o("NolebasePageProperties"),a=o("VPNolebaseInlineLinkPreview"),l=o("NolebaseGitContributors"),r=o("NolebaseGitChangelog");return h(),c("div",null,[k,s(n),b,e("table",g,[q,e("tbody",null,[e("tr",null,[v,_,e("td",null,[s(a,{href:"https://kubesphere.io/zh/docs/v3.3/",target:"_blank",rel:"noreferrer"},{default:i(()=>[t("https://kubesphere.io/zh/docs/v3.3/")]),_:1})])]),e("tr",null,[m,y,e("td",null,[s(a,{href:"https://v1-22.docs.kubernetes.io/",target:"_blank",rel:"noreferrer"},{default:i(()=>[t("https://v1-22.docs.kubernetes.io/")]),_:1})])])])]),C,e("p",null,[s(a,{href:"https://kubesphere.com.cn/forum/d/7378-istio",target:"_blank",rel:"noreferrer"},{default:i(()=>[t("卸载istio组件之后出现问题 - KubeSphere 开发者社区")]),_:1})]),e("p",null,[s(a,{href:"https://blog.csdn.net/xiaoxiaosu1996/article/details/122873848",target:"_blank",rel:"noreferrer"},{default:i(()=>[t("记录k8s中安装kubeSphere的一些问题_xiaoxiaosu1996的博客-CSDN博客")]),_:1})]),e("p",null,[s(a,{href:"https://blog.csdn.net/shandian534/article/details/125987789",target:"_blank",rel:"noreferrer"},{default:i(()=>[t("kubesphere 卸载 istio后 部署服务一直处理队列中_山巅的博客-CSDN博客_kubesphere 队列中")]),_:1})]),s(l),s(r)])}const I=p(u,[["render",f]]);export{w as __pageData,I as default};
